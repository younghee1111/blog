<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¼ì •ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>â°</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        html { overflow-y: scroll; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            padding: 20px; 
            background: #f5f5f5; 
        }
        
        /* 2ë‹¨ ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ */
        .main-layout {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .left-panel {
            flex: 7;
            min-width: 0;
        }
        
        .right-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-width: 280px;
        }
        
        .card {
            background: white;
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* ì˜¤ëŠ˜ì˜ í†µê³„ ì¹´ë“œ */
        .stats-card {
            flex-shrink: 0;
        }
        
        .stat-item {
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .stat-value {
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* ë©”ëª¨ ì¹´ë“œ */
        .memo-card {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .memo-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .memo-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
            resize: none;
            min-height: 120px;
            line-height: 1.6;
            box-sizing: border-box;
        }
        
        .memo-input:focus {
            border-color: #3498db;
        }
        
        .color-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid #e0e0e0;
            transition: all 0.2s;
        }
        
        .color-option:hover {
            transform: scale(1.15);
            border-color: #bbb;
        }
        
        .color-option.active {
            border-color: #2c3e50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .memo-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }
        
        .memo-item {
            padding: 12px;
            padding-right: 36px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
            transition: transform 0.2s;
            white-space: pre-wrap;
            word-break: break-word;
            cursor: move;
            border: 2px solid transparent;
        }
        
        .memo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .memo-item.dragging {
            opacity: 0.5;
        }
        
        .memo-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #e74c3c;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .memo-item:hover .memo-delete {
            opacity: 1;
        }
        
        .memo-delete:hover {
            background: #fff;
        }
        
        .memo-empty {
            text-align: center;
            color: #95a5a6;
            padding: 40px 20px;
            font-size: 14px;
        }
        
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ */
        h1 { color: #2c3e50; margin: 0 0 20px 0; font-size: 20px; text-align: center; }

        button { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        button:hover { filter: brightness(0.95); }
        .btn-soft-green { background:#E5F7E9; color:#1e5e2f; }
        .btn-soft-violet { background:#F0E9FF; color:#5a2e98; }
        .btn-soft-orange { background:#FFE8D6; color:#8a4b13; }
        .btn-soft-blue { background:#E6F0FF; color:#1b4fa3; }
        .btn-danger { background:#FDE2E1; color:#8B1E1A; }
        .btn-soft-pink { background:#FFE6F0; color:#8B1E5A; }

        .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        .row.space { margin-bottom: 15px; }
        .row .spacer { margin-left:auto; }

        table { width:100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 15px; }
        th { background: #34495e; color: white; }

        .duration-cell { background: #ecf0f1; width: 70px; text-align:center; }
        .duration-cell input { text-align:center; width:100%; background: transparent; border: none; outline: none; font-size: 15px; }
        .time-cell { background: #ecf0f1; }
        .task-cell { background: white; text-align:left; }

        .task-input { background: transparent; border: none; outline: none; width: 100%; color:#2c3e50; font-size:15px; padding:8px; }

        #scheduleBody tr.dragging { opacity: 0.5; }
        #scheduleBody tr.drag-over { border-top: 3px solid #3498db; }
        
        .task-cell:focus-within { background:#fafafa !important; }
        
        tr.completed-row .task-cell { background:#f5f5f5 !important; }
        tr.completed-row .task-input { color:#7f8c8d; }
        tr.completed-row .duration-cell { background:#e8e8e8 !important; }
        tr.completed-row .time-cell { background:#e8e8e8 !important; color:#7f8c8d; }
        
        tr.active .task-cell { background:#FFF9E6 !important; }
        tr.active .time-cell { background:#FFF7E6 !important; font-weight:700; }
        
        tr.meal-row .task-cell { background:#F3E8FF !important; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: #2c3e50; font-size: 18px; }
        .modal-close { cursor: pointer; font-size: 28px; color: #95a5a6; line-height: 1; }
        .modal-close:hover { color: #34495e; }
        .modal-body { margin-bottom: 20px; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; }

        .template-item { padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .template-item:hover { background: #f8f9fa; border-color: #3498db; }
        .template-name { font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .template-info { font-size: 12px; color: #7f8c8d; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 14px; }
        .form-group input[type="number"] { width: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .form-group input[type="text"], .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .form-group textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        
        .alarm-section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .alarm-toggle { display: flex; align-items: center; gap: 10px; font-size: 15px; }
        .alarm-toggle input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .alarm-info { margin-top: 15px; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; font-size: 13px; color: #1565c0; line-height: 1.6; }

        /* ë°˜ì‘í˜• */
        @media (max-width: 900px){
            .main-layout {
                flex-direction: column;
            }
            
            .right-panel {
                min-width: 0;
            }
            
            .memo-card {
                min-height: 200px;
            }
        }

        @media (max-width: 720px){ 
            body { padding: 10px; }
            th, td { padding:6px; font-size:14px; } 
            button { padding: 6px 10px; font-size: 11px; }
            .modal-content { padding: 20px; }
            .summary-bar { flex-direction: column; gap: 10px; }
            .card { padding: 16px; }
        }
    </style>
</head>
<body>
<div class="main-layout">
    <!-- ì™¼ìª½ íŒ¨ë„: ì¼ì •ê´€ë¦¬ ì‹œìŠ¤í…œ -->
    <div class="left-panel">
        <div class="card">
            <h1>ğŸ“… ì¼ì •ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>

            <div class="row space">
                <div class="row">
                    <button class="btn-soft-pink" onclick="openTemplateModal()">ğŸ“‹ í…œí”Œë¦¿</button>
                    <button class="btn-soft-blue" onclick="openAlarmModal()">ğŸ”” ì•ŒëŒì„¤ì •</button>
                </div>
                <div class="spacer"></div>
                <div class="row">
                    <button class="btn-soft-violet" onclick="undoDelete()">â†©ï¸ ì´ì „</button>
                    <button class="btn-soft-green" onclick="copyWorkContent()">ğŸ“‹ ì—…ë¬´ë‚´ìš©</button>
                </div>
            </div>

            <table id="scheduleTable">
                <thead>
                    <tr>
                        <th style="width:70px;">ì‹œê°„ ë‹¨ìœ„</th>
                        <th style="width:120px;">ì‹œê°„</th>
                        <th>í• ì¼</th>
                    </tr>
                </thead>
                <tbody id="scheduleBody"></tbody>
            </table>
        </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„: í†µê³„ & ë©”ëª¨ -->
    <div class="right-panel">
        <!-- ì˜¤ëŠ˜ì˜ í†µê³„ ì¹´ë“œ -->
        <div class="card stats-card">
            <div class="card-title">
                <span>ğŸ“Š</span>
                <span>ì˜¤ëŠ˜ì˜ í†µê³„</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ì—…ë¬´ ì‹œê°„</span>
                <span class="stat-value" id="statWorkTime">0ì‹œê°„ (0ê°œ)</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ì™„ë£Œ ì¼ì •</span>
                <span class="stat-value" id="statCompleted">0ì‹œê°„ (0ê°œ)</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ë‚¨ì€ ì¼ì •</span>
                <span class="stat-value" id="statRemaining">0ì‹œê°„ (0ê°œ)</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ì™„ë£Œìœ¨</span>
                <span class="stat-value" id="statProgress">0%</span>
            </div>
        </div>

        <!-- ë©”ëª¨ ì¹´ë“œ -->
        <div class="card memo-card">
            <div class="card-title">
                <span>ğŸ“</span>
                <span>ë©”ëª¨</span>
            </div>
            <div class="memo-input-container">
                <textarea 
                    class="memo-input" 
                    id="memoInput" 
                    placeholder=""
                    onkeydown="handleMemoKeyDown(event)"
                ></textarea>
                <div class="color-selector">
                    <div class="color-option active" style="background:#FFF9E6;" data-color="#FFF9E6" onclick="setSelectedColor(this)"></div>
                    <div class="color-option" style="background:#FFE6F0;" data-color="#FFE6F0" onclick="setSelectedColor(this)"></div>
                    <div class="color-option" style="background:#E6F0FF;" data-color="#E6F0FF" onclick="setSelectedColor(this)"></div>
                    <div class="color-option" style="background:#E5F7E9;" data-color="#E5F7E9" onclick="setSelectedColor(this)"></div>
                    <div class="color-option" style="background:#F0E9FF;" data-color="#F0E9FF" onclick="setSelectedColor(this)"></div>
                </div>
            </div>
            <div class="memo-list" id="memoList">
                <div class="memo-empty"></div>
            </div>
        </div>
    </div>
</div>

<!-- ëª¨ë‹¬ë“¤ -->
<div id="templateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ“‹ í…œí”Œë¦¿ ê´€ë¦¬</h2>
            <span class="modal-close" onclick="closeTemplateModal()">&times;</span>
        </div>
        <div class="modal-body">
            <button class="btn-soft-green" onclick="openSaveTemplateModal()" style="width:100%; margin-bottom:20px;">ğŸ’¾ í˜„ì¬ ì¼ì •ì„ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥</button>
            <div id="templateList"></div>
        </div>
    </div>
</div>

<div id="saveTemplateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ’¾ í…œí”Œë¦¿ ì €ì¥</h2>
            <span class="modal-close" onclick="closeSaveTemplateModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>í…œí”Œë¦¿ ì´ë¦„</label>
                <input type="text" id="templateName" placeholder="ì˜ˆ: í‰ì¼ ë£¨í‹´" />
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-soft-orange" onclick="closeSaveTemplateModal()">ì·¨ì†Œ</button>
            <button class="btn-soft-green" onclick="saveTemplate()">ì €ì¥</button>
        </div>
    </div>
</div>

<div id="alarmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ”” ì•ŒëŒ ì„¤ì •</h2>
            <span class="modal-close" onclick="closeAlarmModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="alarm-section">
                <label class="alarm-toggle">
                    <input type="checkbox" id="alarmEnabled" onchange="toggleAlarm(this.checked)">
                    <span style="font-weight:600;">ì•ŒëŒ í™œì„±í™”</span>
                </label>
            </div>
            
            <div class="form-group">
                <label>ì¢…ë£Œ ëª‡ ë¶„ ì „ì— ì•Œë¦¼</label>
                <input type="number" id="alarmMinutes" value="5" min="1" max="60" onchange="saveAlarmSettings()">
                <span style="margin-left:8px; color:#7f8c8d;">ë¶„</span>
            </div>

            <button class="btn-soft-blue" onclick="testAlarm()" style="width:100%; padding:12px; font-size:14px;">ğŸ”” ì•ŒëŒ í…ŒìŠ¤íŠ¸</button>
            
            <div class="alarm-info">
                ğŸ’¡ ì•ŒëŒì„ ë°›ìœ¼ë ¤ë©´ ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
                â€¢ ì‹œì‘ ì•Œë¦¼: ê° í• ì¼ ì‹œì‘ ì‹œì <br>
                â€¢ ì¢…ë£Œ ì•Œë¦¼: ì„¤ì •í•œ ì‹œê°„ ì „
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-soft-green" onclick="closeAlarmModal()">í™•ì¸</button>
        </div>
    </div>
</div>

<script>
/* ------------------------------
   ì „ì—­ ìƒíƒœ
------------------------------ */
let schedules = [];
let templates = [];
let draggedIndex = null;
let alarmSettings = { enabled: false, minutesBefore: 5 };
let notifiedTasks = new Set();
let alarmCheckInterval = null;
let deletedHistory = [];
let memos = [];
let selectedMemoColor = '#FFF9E6';
let draggedMemoIndex = null;
const START_TIME = "9:00";
const WINDOW = 0.05; // ì•ŒëŒ í—ˆìš© êµ¬ê°„(ì•½ 3ë¶„)

/* ------------------------------
   ê³µí†µ ìœ í‹¸
------------------------------ */
function parseTime(t){ const [h, m] = t.split(':').map(Number); return h + m/60; }

function formatTime(h){
    const hours = Math.floor(h);
    const minutes = Math.round((h - hours) * 60);
    let displayHour = hours % 12; 
    if(displayHour === 0) displayHour = 12;
    return `${displayHour}:${minutes.toString().padStart(2,'0')}`;
}

function nowInHours(){ const n = new Date(); return n.getHours() + n.getMinutes()/60; }

function formatHours(totalHours){
    const hours = Math.floor(totalHours);
    const minutes = Math.round((totalHours - hours) * 60);
    
    if(hours > 0 && minutes > 0){
        return `${hours}ì‹œê°„ ${minutes}ë¶„`;
    } else if(hours > 0){
        return `${hours}ì‹œê°„`;
    } else if(minutes > 0){
        return `${minutes}ë¶„`;
    } else {
        return `0ì‹œê°„`;
    }
}

/* ------------------------------
   ì¼ì • ê°ì²´ ìƒì„± + ID ë³´ì¥
------------------------------ */
function createSchedule(duration = 1, task = '', completed = false){
    return {
        id: Date.now() + Math.random(),
        duration,
        task,
        completed,
        start: '',
        end: '',
        startNum: 0,
        endNum: 0
    };
}

function ensureScheduleIds(){
    schedules.forEach(s => {
        if(!s.id){
            s.id = Date.now() + Math.random();
        }
    });
}

/* ------------------------------
   ë°ì´í„° ë¡œë“œ/ì €ì¥
------------------------------ */
function loadData(){
    const saved = localStorage.getItem('scheduleData');
    const savedTemplates = localStorage.getItem('templates');
    const savedAlarmSettings = localStorage.getItem('alarmSettings');
    const savedMemos = localStorage.getItem('dailyMemos');
    
    if(saved){ 
        schedules = JSON.parse(saved); 
    } else { 
        schedules = [ createSchedule(1, '', false) ];
    }
    ensureScheduleIds();
    
    if(savedTemplates){ templates = JSON.parse(savedTemplates); }
    
    if(savedAlarmSettings){
        alarmSettings = JSON.parse(savedAlarmSettings);
        document.getElementById('alarmEnabled').checked = alarmSettings.enabled;
        document.getElementById('alarmMinutes').value = alarmSettings.minutesBefore;
    }
    
    if(savedMemos){
        memos = JSON.parse(savedMemos);
    }
    
    ensureDailyReset();
    renderMemos();
    renderTable();
    initAlarmSystem();
    updateStats();
}

function saveData(){
    localStorage.setItem('scheduleData', JSON.stringify(schedules));
    localStorage.setItem('templates', JSON.stringify(templates));
    localStorage.setItem('alarmSettings', JSON.stringify(alarmSettings));
    localStorage.setItem('dailyMemos', JSON.stringify(memos));
}

/* ------------------------------
   ë©”ëª¨ ê´€ë ¨
------------------------------ */
function setSelectedColor(element){
    document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('active');
    });
    element.classList.add('active');
    selectedMemoColor = element.dataset.color;
}

function handleMemoKeyDown(event){
    if(event.key === 'Enter' && !event.shiftKey){
        event.preventDefault();
        addMemoItem();
    }
}

function addMemoItem(){
    const input = document.getElementById('memoInput');
    const text = input.value.trim();
    if(!text) return;
    
    memos.unshift({
        id: Date.now(),
        text,
        color: selectedMemoColor,
        createdAt: new Date().toISOString()
    });
    
    input.value = '';
    input.focus();
    saveData();
    renderMemos();
}

function deleteMemoItem(id){
    memos = memos.filter(m => m.id !== id);
    saveData();
    renderMemos();
}

function renderMemos(){
    const container = document.getElementById('memoList');
    container.innerHTML = '';
    
    if(memos.length === 0){
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'memo-empty';
        emptyDiv.textContent = '';
        container.appendChild(emptyDiv);
        return;
    }
    
    memos.forEach((memo, index) => {
        const div = document.createElement('div');
        div.className = 'memo-item';
        div.draggable = true;
        div.dataset.memoIndex = index;
        div.style.background = memo.color;
        div.appendChild(document.createTextNode(memo.text));
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'memo-delete';
        deleteBtn.textContent = 'Ã—';
        deleteBtn.addEventListener('click', function(e) { 
            e.stopPropagation();
            deleteMemoItem(memo.id); 
        });
        div.appendChild(deleteBtn);
        
        div.addEventListener('dragstart', function(e) {
            draggedMemoIndex = index;
            div.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });
        
        div.addEventListener('dragover', function(e) {
            e.preventDefault();
        });
        
        div.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropIndex = parseInt(div.dataset.memoIndex, 10);
            if(draggedMemoIndex === null || draggedMemoIndex === dropIndex) return;
            
            const rect = div.getBoundingClientRect();
            const isAfter = e.clientY > rect.top + rect.height / 2;
            
            const memoItem = memos.splice(draggedMemoIndex, 1)[0];
            let targetIndex = dropIndex;
            if(isAfter) targetIndex = dropIndex + 1;
            if(draggedMemoIndex < targetIndex) targetIndex--;
            memos.splice(targetIndex, 0, memoItem);
            
            saveData();
            renderMemos();
        });
        
        div.addEventListener('dragleave', function() {});
        
        div.addEventListener('dragend', function() {
            const allMemos = container.querySelectorAll('.memo-item');
            allMemos.forEach(item => {
                item.classList.remove('dragging');
            });
            draggedMemoIndex = null;
        });
        
        container.appendChild(div);
    });

    // ë§¨ ì•„ë˜ë¡œ ë³´ë‚´ëŠ” tail ì˜ì—­
    const tail = document.createElement('div');
    tail.style.height = '28px';
    tail.style.border = '2px dashed transparent';
    tail.style.marginTop = '4px';

    tail.addEventListener('dragover', function(e){
        e.preventDefault();
    });

    tail.addEventListener('drop', function(e){
        e.preventDefault();
        if(draggedMemoIndex === null) return;
        const memoItem = memos.splice(draggedMemoIndex, 1)[0];
        memos.push(memoItem);
        saveData();
        renderMemos();
    });

    container.appendChild(tail);
}

/* ------------------------------
   ì¼ì • ê³„ì‚° / ë Œë”ë§
------------------------------ */
function calculateTimes(){
    let cur = parseTime(START_TIME);
    schedules.forEach(s => { 
        s.start = formatTime(cur); 
        s.startNum = cur; 
        cur += s.duration; 
        s.end = formatTime(cur); 
        s.endNum = cur; 
    });
}

function renderTable(){
    calculateTimes();
    updateStats();
    const tbody = document.getElementById('scheduleBody');
    tbody.innerHTML = '';
    const nowH = nowInHours();
    
    schedules.forEach((s, i) => {
        const tr = document.createElement('tr');
        tr.draggable = true;
        tr.dataset.index = i;
        tr.dataset.id = s.id;
        
        const isMeal = /ì ì‹¬|ì ì‹¬ì‹ì‚¬|ì €ë…|ì €ë…ì‹ì‚¬|íšŒì˜/i.test(s.task);
        if(isMeal) tr.classList.add('meal-row');
        
        if(nowH >= s.startNum && nowH < s.endNum) {
            tr.classList.add('active');
        }
        
        if(nowH >= s.endNum) {
            s.completed = true;
        }
        
        if(s.completed) tr.classList.add('completed-row');

        const d = document.createElement('td'); 
        d.className = 'duration-cell'; 
        const durationInput = document.createElement('input');
        durationInput.type = 'number';
        durationInput.step = '0.5';
        durationInput.value = s.duration;
        durationInput.addEventListener('change', function() { 
            s.duration = parseFloat(this.value) || 0.5;
            updateAllTimes();
        });
        d.appendChild(durationInput);
        tr.appendChild(d);
        
        const t = document.createElement('td'); 
        t.className = 'time-cell'; 
        t.textContent = `${s.start} - ${s.end}`;
        tr.appendChild(t);
        
        const task = document.createElement('td'); 
        task.className = 'task-cell';
        const input = document.createElement('input');
        input.className = 'task-input';
        input.type = 'text';
        input.value = s.task || '';
        
        input.addEventListener('input', function() { 
            s.task = this.value;
        });
        
        input.addEventListener('blur', function() { 
            s.task = this.value;
            saveData();
        });
        
        input.addEventListener('keydown', function(e) { 
            // Ctrl + D: í˜„ì¬ í–‰ ë³µì‚¬
            if(e.ctrlKey && e.key === 'd'){
                e.preventDefault();
                s.task = this.value;
                const newSchedule = createSchedule(s.duration, '', false);
                const idx = schedules.indexOf(s);
                schedules.splice(idx + 1, 0, newSchedule);
                updateAllTimes(); 
                setTimeout(() => {
                    const inputs = document.querySelectorAll('.task-input');
                    if(inputs[idx + 1]) inputs[idx + 1].focus();
                }, 50);
                return;
            }
            
            // Ctrl + Backspace: í˜„ì¬ í–‰ ì‚­ì œ (id ê¸°ë°˜)
            if(e.ctrlKey && e.key === 'Backspace'){
                e.preventDefault();
                deleteRowById(s.id);
                return;
            }
            
            // Ctrl + Enter: í˜„ì¬ í–‰ ì•„ë˜ì— ìƒˆ í–‰ ì¶”ê°€
            if(e.ctrlKey && e.key === 'Enter'){
                e.preventDefault();
                s.task = this.value;
                const idx = schedules.indexOf(s);
                const newSchedule = createSchedule(1, '', false);
                schedules.splice(idx + 1, 0, newSchedule);
                updateAllTimes();
                setTimeout(() => {
                    const inputs = document.querySelectorAll('.task-input');
                    if(inputs[idx + 1]) inputs[idx + 1].focus();
                }, 50);
                return;
            }
            
            // Enter: ë‹¤ìŒ í• ì¼ë¡œ ì´ë™
            if(e.key === 'Enter'){
                e.preventDefault();
                s.task = this.value;
                saveData();
                
                const idx = schedules.indexOf(s);
                const nextIndex = idx + 1;
                if(nextIndex < schedules.length){
                    setTimeout(() => {
                        const inputs = document.querySelectorAll('.task-input');
                        if(inputs[nextIndex]) inputs[nextIndex].focus();
                    }, 0);
                }
                return;
            }
            
            if(e.key === 'ArrowDown'){
                e.preventDefault();
                s.task = this.value;
                saveData();
                
                const idx = schedules.indexOf(s);
                const nextIndex = idx + 1;
                if(nextIndex < schedules.length){
                    setTimeout(() => {
                        const inputs = document.querySelectorAll('.task-input');
                        if(inputs[nextIndex]) inputs[nextIndex].focus();
                    }, 0);
                }
            } else if(e.key === 'ArrowUp'){
                e.preventDefault();
                s.task = this.value;
                saveData();
                
                const idx = schedules.indexOf(s);
                const prevIndex = idx - 1;
                if(prevIndex >= 0){
                    setTimeout(() => {
                        const inputs = document.querySelectorAll('.task-input');
                        if(inputs[prevIndex]) inputs[prevIndex].focus();
                    }, 0);
                }
            }
        });
        
        task.appendChild(input);
        tr.appendChild(task);
        
        tr.addEventListener('dragstart', handleDragStart);
        tr.addEventListener('dragover', handleDragOver);
        tr.addEventListener('drop', handleDrop);
        tr.addEventListener('dragend', handleDragEnd);
        
        tbody.appendChild(tr);
    });
}

function handleDragStart(e){
    draggedIndex = parseInt(this.dataset.index, 10);
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e){
    if(e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    this.classList.add('drag-over');
    return false;
}

function handleDrop(e){
    if(e.stopPropagation) e.stopPropagation();
    const dropIndex = parseInt(this.dataset.index, 10);
    if(draggedIndex !== dropIndex){
        const item = schedules.splice(draggedIndex, 1)[0];
        schedules.splice(dropIndex, 0, item);
        updateAllTimes();
    }
    return false;
}

function handleDragEnd(e){
    document.querySelectorAll('#scheduleBody tr').forEach(tr => {
        tr.classList.remove('dragging', 'drag-over');
    });
}

/* ------------------------------
   ì‚­ì œ / Undo
------------------------------ */
function deleteRowById(rowId){
    const index = schedules.findIndex(s => s.id === rowId);
    if(index === -1) return;
    if(schedules.length === 1) return;
    
    deletedHistory.push({
        index,
        data: JSON.parse(JSON.stringify(schedules[index]))
    });
    
    schedules.splice(index, 1);
    updateAllTimes();
    
    setTimeout(() => {
        const inputs = document.querySelectorAll('.task-input');
        const focusIndex = Math.min(index, inputs.length - 1);
        if(inputs[focusIndex]) inputs[focusIndex].focus();
    }, 50);
}

function undoDelete(){
    if(deletedHistory.length === 0){
        return;
    }
    const last = deletedHistory.pop();
    const insertIndex = Math.min(last.index, schedules.length);
    schedules.splice(insertIndex, 0, last.data);
    updateAllTimes();
}

/* ------------------------------
   ê¸°íƒ€ ê¸°ëŠ¥
------------------------------ */
function copyWorkContent(){
    let content = '';
    schedules.forEach(s => {
        const isMeal = /ì ì‹¬|ì ì‹¬ì‹ì‚¬|ì €ë…|ì €ë…ì‹ì‚¬|íšŒì˜/i.test(s.task);
        if(!isMeal && s.task.trim()){
            content += `- ${s.task}(${s.duration}ì‹œê°„)\n`;
        }
    });
    
    if(!content){
        return;
    }
    
    navigator.clipboard.writeText(content).then(() => {
    }).catch(err => {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
    });
}

function updateAllTimes(){ 
    ensureScheduleIds();
    calculateTimes(); 
    renderTable(); 
    saveData(); 
}

function updateStats(){
    const nowH = nowInHours();
    
    // (1) ì—…ë¬´ ì‹œê°„ = ì „ì²´ ì¼ì • ì´ì‹œê°„
    let allHours = 0;
    let allCount = schedules.length;

    // (2) ë‚¨ì€ ì¼ì • (íšŒì˜/ì‹ì‚¬ í¬í•¨)
    let remainingHours = 0;
    let remainingCount = 0;

    // (3) ì™„ë£Œ ì¼ì • (ì‹ì‚¬ ì œì™¸)
    let completedHours = 0;
    let completedCount = 0;

    // (4) ì™„ë£Œìœ¨ = ì „ì²´ ì¼ì • ê¸°ì¤€
    let wholeCompletedHours = 0;

    schedules.forEach(s => {
        const isMeal = /ì ì‹¬|ì ì‹¬ì‹ì‚¬|ì €ë…|ì €ë…ì‹ì‚¬|ì‹ì‚¬/i.test(s.task);

        // ì „ì²´ ì¼ì • ì´ì‹œê°„
        allHours += s.duration;

        // ì™„ë£Œìœ¨ ê³„ì‚°ìš©: ì „ì²´ ì¼ì • ê¸°ì¤€
        if(s.completed){
            wholeCompletedHours += s.duration;
        }

        // ë‚¨ì€ ì¼ì •: íšŒì˜/ì‹ì‚¬ í¬í•¨
        if(nowH < s.endNum){
            remainingHours += s.duration;
            remainingCount++;
        }

        // ì™„ë£Œ ì¼ì •: ì™„ë£Œ + ì‹ì‚¬ ì œì™¸
        if(s.completed && !isMeal){
            completedHours += s.duration;
            completedCount++;
        }
    });

    const progressPercent = allHours > 0
        ? Math.round((wholeCompletedHours / allHours) * 100)
        : 0;

    document.getElementById('statWorkTime').textContent =
        `${formatHours(allHours)} (${allCount}ê°œ)`;

    document.getElementById('statCompleted').textContent =
        `${formatHours(completedHours)} (${completedCount}ê°œ)`;

    document.getElementById('statRemaining').textContent =
        `${formatHours(remainingHours)} (${remainingCount}ê°œ)`;

    document.getElementById('statProgress').textContent = `${progressPercent}%`;
}


function ensureDailyReset(){
    const today = new Date().toDateString();
    const last = localStorage.getItem('lastReset');
    if(last !== today){
        schedules.forEach(s => { s.completed = false; });
        localStorage.setItem('lastReset', today);
        notifiedTasks.clear();
        saveData();
        renderTable();
    }
}

/* ------------------------------
   í…œí”Œë¦¿ ê´€ë ¨
------------------------------ */
function openTemplateModal(){ renderTemplateList(); document.getElementById('templateModal').classList.add('show'); }
function closeTemplateModal(){ document.getElementById('templateModal').classList.remove('show'); }
function openSaveTemplateModal(){ document.getElementById('templateName').value = ''; document.getElementById('saveTemplateModal').classList.add('show'); }
function closeSaveTemplateModal(){ document.getElementById('saveTemplateModal').classList.remove('show'); }

function saveTemplate(){
    const name = document.getElementById('templateName').value.trim();
    if(!name){ alert('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    
    templates.push({
        id: Date.now(),
        name: name,
        schedules: JSON.parse(JSON.stringify(schedules)),
        createdAt: new Date().toISOString()
    });
    
    saveData();
    closeSaveTemplateModal();
    renderTemplateList();
    alert('í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

function renderTemplateList(){
    const container = document.getElementById('templateList');
    if(templates.length === 0){
        container.innerHTML = '<p style="color:#7f8c8d; text-align:center;">ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    container.innerHTML = templates.map((t, i) => `
        <div class="template-item" onclick="loadTemplate(${i})">
            <div class="template-name">${t.name}</div>
            <div class="template-info">
                ${t.schedules.length}ê°œ ì¼ì • Â· ${new Date(t.createdAt).toLocaleDateString()}
                <button class="btn-danger" onclick="event.stopPropagation(); deleteTemplate(${i})" style="float:right; padding:4px 8px; font-size:11px;">ì‚­ì œ</button>
            </div>
        </div>
    `).join('');
}

function loadTemplate(index){
    if(confirm('í˜„ì¬ ì¼ì •ì„ í…œí”Œë¦¿ìœ¼ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
        const template = templates[index];
        schedules = JSON.parse(JSON.stringify(template.schedules));
        ensureScheduleIds();
        updateAllTimes();
        closeTemplateModal();
        alert('í…œí”Œë¦¿ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
}

function deleteTemplate(index){ 
    if(confirm('ì´ í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ 
        templates.splice(index, 1); 
        saveData(); 
        renderTemplateList(); 
    } 
}

/* ------------------------------
   ì•ŒëŒ ì‹œìŠ¤í…œ
------------------------------ */
async function initAlarmSystem(){
    if('Notification' in window && Notification.permission === 'default'){
        await Notification.requestPermission();
    }
    if(alarmSettings.enabled) startAlarmCheck();
}

function startAlarmCheck(){
    if(alarmCheckInterval) clearInterval(alarmCheckInterval);
    alarmCheckInterval = setInterval(() => {
        checkAndNotify(nowInHours());
    }, 10000);
    checkAndNotify(nowInHours());
}

function stopAlarmCheck(){ 
    if(alarmCheckInterval){ 
        clearInterval(alarmCheckInterval); 
        alarmCheckInterval = null; 
    } 
}

function checkAndNotify(nowH){
    if(!alarmSettings.enabled || Notification.permission !== 'granted') return;
    
    calculateTimes();
    
    schedules.forEach((s) => {
        if(s.completed) return;
        
        const startKey = `start-${s.id}`;
        const endKey   = `end-${s.id}`;
        
        // ì‹œì‘ ì•ŒëŒ (ì‹œì‘ ì‹œì  ê·¼ì²˜ì—ì„œ 1ë²ˆ)
        if(
            nowH >= s.startNum &&
            nowH <  s.startNum + WINDOW &&
            !notifiedTasks.has(startKey)
        ){
            notifiedTasks.add(startKey);
            showStartNotification(s);
        }
        
        // ì¢…ë£Œ ì•ŒëŒ (ì¢…ë£Œ minutesBefore ë¶„ ì „ ê·¼ì²˜ì—ì„œ 1ë²ˆ)
        const alarmTime = s.endNum - (alarmSettings.minutesBefore / 60);
        if(
            nowH >= alarmTime &&
            nowH <  alarmTime + WINDOW &&
            !notifiedTasks.has(endKey)
        ){
            notifiedTasks.add(endKey);
            showEndNotification(s);
        }
    });
}

function showStartNotification(currentTask){
    const notification = new Notification('ğŸ¯ í• ì¼ ì‹œì‘', {
        body: `[í˜„ì¬ í• ì¼]\n${currentTask.task || 'í• ì¼ ì—†ìŒ'}`,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">ğŸ¯</text></svg>',
        tag: 'schedule-start-' + Date.now(),
        requireInteraction: true,
        silent: false
    });
    
    notification.onclick = function(){ window.focus(); this.close(); };
}

function showEndNotification(currentTask){
    const notification = new Notification(`ğŸ“… ${alarmSettings.minutesBefore}ë¶„ ì „ ì¢…ë£Œ`, {
        body: `[í˜„ì¬ í• ì¼]\n${currentTask.task || 'í• ì¼ ì—†ìŒ'}`,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">ğŸ“…</text></svg>',
        tag: 'schedule-end-' + Date.now(),
        requireInteraction: true,
        silent: false
    });
    
    notification.onclick = function(){ window.focus(); this.close(); };
}

function openAlarmModal(){ document.getElementById('alarmModal').classList.add('show'); }
function closeAlarmModal(){ document.getElementById('alarmModal').classList.remove('show'); }

function toggleAlarm(enabled){
    alarmSettings.enabled = enabled;
    saveAlarmSettings();
    if(enabled) initAlarmSystem();
    else stopAlarmCheck();
}

function saveAlarmSettings(){
    alarmSettings.minutesBefore = parseInt(document.getElementById('alarmMinutes').value) || 5;
    alarmSettings.enabled = document.getElementById('alarmEnabled').checked;
    saveData();
    if(alarmSettings.enabled){ 
        startAlarmCheck(); 
        alert('ì•ŒëŒ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    } else {
        stopAlarmCheck();
    }
}

async function testAlarm(){
    if(Notification.permission !== 'granted'){
        const permission = await Notification.requestPermission();
        if(permission !== 'granted'){ 
            alert('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì•Œë¦¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.'); 
            return; 
        }
    }
    
    const notification = new Notification('ğŸ”” ì•ŒëŒ í…ŒìŠ¤íŠ¸', {
        body: `ì¢…ë£Œ ${alarmSettings.minutesBefore}ë¶„ ì „\n\në‹¤ìŒ í• ì¼: í…ŒìŠ¤íŠ¸ í• ì¼`,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">ğŸ””</text></svg>',
        tag: 'test-alarm-' + Date.now(),
        requireInteraction: true
    });
    
    notification.onclick = function(){ window.focus(); this.close(); };
}

/* ------------------------------
   ì£¼ê¸°ì ìœ¼ë¡œ í˜„ì¬ active í–‰ ë¦¬ë Œë”
------------------------------ */
setInterval(() => {
    const nowH = nowInHours();
    calculateTimes();
    let needRender = false;
    schedules.forEach(s => {
        if(nowH >= s.startNum && nowH < s.endNum){
            needRender = true;
        }
    });
    if(needRender) renderTable();
}, 60000);

/* ------------------------------ */
loadData();
</script>
</body>
</html>
