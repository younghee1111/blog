<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¼ì •ê´€ë¦¬ ì‹œìŠ¤í…œ (ì•ŒëŒê¸°ëŠ¥ ê°•í™”)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>â°</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        html { overflow-y: auto; height: 100%; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; display: flex; justify-content: center; height: 100%; box-sizing: border-box; }
        
        .main-layout { display: flex; gap: 20px; max-width: 1600px; width: 100%; margin-top: 20px; }
        .left-panel { flex: 0 0 1300px; min-width: 0; }
        .right-panel { flex: 0 0 280px; display: flex; flex-direction: column; gap: 16px; min-width: 280px; }
        
        .card { background: white; padding: 24px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card-title { font-size: 16px; font-weight: 600; color: #2c3e50; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        
        .card-title .color-selector-inline { display: flex; gap: 4px; margin-left: auto; }
        .card-title .color-option { width: 18px; height: 18px; border-radius: 4px; cursor: pointer; border: 2px solid #e0e0e0; transition: all 0.2s; }
        .card-title .color-option:hover { transform: scale(1.1); border-color: #bbb; }
        .card-title .color-option.active { border-color: #2c3e50; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        
        .stats-card { flex-shrink: 0; }
        .stat-item { padding: 12px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .stat-item:last-child { border-bottom: none; }
        .stat-label { font-size: 14px; color: #7f8c8d; }
        .stat-value { font-size: 15px; font-weight: 600; color: #2c3e50; }
        
        .memo-card { flex: 0; display: flex; flex-direction: column; }
        .memo-input-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 8px; }
        .memo-input { width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 14px; outline: none; transition: border-color 0.2s; resize: none; min-height: 60px; line-height: 1.6; box-sizing: border-box; }
        .memo-input:focus { border-color: #3498db; }
        .memo-list { display: flex; flex-direction: column; gap: 10px; }
        .memo-item { padding: 12px; padding-right: 36px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; word-wrap: break-word; font-size: 14px; line-height: 1.5; transition: transform 0.2s; white-space: pre-wrap; word-break: break-word; cursor: move; border: 2px solid transparent; }
        .memo-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .memo-item.dragging { opacity: 0.5; }
        .memo-delete { position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.9); border: none; border-radius: 4px; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #e74c3c; opacity: 0; transition: opacity 0.2s; }
        .memo-item:hover .memo-delete { opacity: 1; }
        .memo-delete:hover { background: #fff; }
        .memo-empty { text-align: center; color: #95a5a6; padding: 0px; font-size: 14px; }
        
        h1 { color: #2c3e50; margin: 0 0 20px 0; font-size: 20px; text-align: center; }
        button { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        button:hover { filter: brightness(0.95); }
        .btn-soft-green { background:#E5F7E9; color:#1e5e2f; }
        .btn-soft-violet { background:#F0E9FF; color:#5a2e98; }
        .btn-soft-orange { background:#FFE8D6; color:#8a4b13; }
        .btn-soft-blue { background:#E6F0FF; color:#1b4fa3; }
        .btn-danger { background:#FDE2E1; color:#8B1E1A; }
        .btn-soft-pink { background:#FFE6F0; color:#8B1E5A; }
        .btn-soft-teal { background:#E0F2F1; color:#00695C; }

        .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        .row.space { margin-bottom: 15px; }
        .row .spacer { margin-left:auto; }

        table { width:100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 15px; }
        th { background: #34495e; color: white; }

        .duration-cell { background: #ecf0f1; width: 120px; text-align:center; }
        .duration-cell input { text-align:center; width:100%; background: transparent; border: none; outline: none; font-size: 15px; }
        .time-cell { background: #ecf0f1; width: 180px; }
        .task-cell { background: white; text-align:left; vertical-align: middle; padding: 0; }

        .task-input { background: transparent; border: none; outline: none; width: 100%; color:#1A1A1A; font-size:16px; padding: 8px; resize: none; overflow: hidden; white-space: pre-wrap; word-wrap: break-word; font-family: inherit; line-height: 1.4; min-height: auto; text-align: left; box-sizing: border-box; display: block; vertical-align: top; }
        .memo-input-cell { background: transparent; border: none; outline: none; width: 100%; color:#1A1A1A; font-size:16px; padding: 8px; resize: none; overflow: hidden; white-space: pre-wrap; word-wrap: break-word; font-family: inherit; line-height: 1.4; min-height: auto; text-align: left; box-sizing: border-box; display: block; vertical-align: top; }
        
        #scheduleBody tr.dragging { opacity: 0.5; }
        #scheduleBody tr.drag-over { border-top: 3px solid #3498db; }
        
        tr:not(.completed-row):not(.active):not(.meal-row) .task-cell { background: #fdfdfd !important; }
        tr:not(.completed-row):not(.active):not(.meal-row):focus-within .task-cell { background:#e0e0e0 !important; }
        
        tr.active:not(.completed-row):not(.meal-row) .task-cell { background:#FFF9E6 !important; }
        tr.active:not(.completed-row):not(.meal-row):focus-within .task-cell { background:#FFF3CC !important; }
        tr.active:not(.completed-row):not(.meal-row) .time-cell { background:#FFF7E6 !important; font-weight:700; }
        
        tr.completed-row:not(.meal-row) .task-cell { background:#e8e8e8 !important; }
        tr.completed-row:not(.meal-row):focus-within .task-cell { background:#d4d4d4 !important; }
        tr.completed-row:not(.meal-row) .task-input { color:#5f5e5e; }
        tr.completed-row:not(.meal-row) .memo-input-cell { color:#5f5e5e; }
        tr.completed-row:not(.meal-row) .duration-cell { background:#e8e8e8 !important; }
        tr.completed-row:not(.meal-row) .time-cell { background:#e8e8e8 !important; color:#5f5e5e; }
        
        tr.meal-row .task-cell { background:#F3E8FF !important; }
        tr.meal-row:focus-within .task-cell { background:#E8D9FF !important; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: #2c3e50; font-size: 18px; }
        .modal-close { cursor: pointer; font-size: 28px; color: #95a5a6; line-height: 1; }
        .modal-close:hover { color: #34495e; }
        .modal-body { margin-bottom: 20px; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; }

        .template-item { padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .template-item:hover { background: #f8f9fa; border-color: #3498db; }
        .template-name { font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .template-info { font-size: 12px; color: #7f8c8d; }

        .backup-item { padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .backup-item:hover { background: #f8f9fa; border-color: #3498db; }
        .backup-date { font-weight: bold; color: #2c3e50; }
        .backup-time { font-size: 12px; color: #7f8c8d; margin-top: 3px; }
        .backup-empty { text-align: center; color: #95a5a6; padding: 40px 20px; font-size: 14px; }
        
        .dday-card { flex-shrink: 0; }
        .dday-item { padding: 10px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .dday-item:last-child { border-bottom: none; }
        .dday-title { font-size: 13px; color: #2c3e50; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .dday-delete { background: transparent; border: none; cursor: pointer; color: #bdc3c7; font-size: 18px; padding: 0 4px; margin-left: 8px; transition: color 0.2s; line-height: 1; }
        .dday-delete:hover { color: #e74c3c; }
        .dday-badge { font-size: 12px; font-weight: 600; padding: 4px 8px; border-radius: 4px; margin-left: 8px; }
        .dday-today { background: #e74c3c; color: white; }
        .dday-urgent { background: #e67e22; color: white; }
        .dday-soon { background: #f39c12; color: white; }
        .dday-normal { background: #3498db; color: white; }
        .dday-passed { background: #95a5a6; color: white; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 14px; }
        .form-group input[type="number"] { width: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .form-group input[type="text"], .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .form-group textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        
        /* === ê°œì„ ëœ ì•ŒëŒ ì„¤ì • ìŠ¤íƒ€ì¼ === */
        .alarm-header-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        .switch-label {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ ë””ìì¸ */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196f3;
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }

        .alarm-settings-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .alarm-setting-card {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            background: #fff;
            transition: all 0.2s;
        }
        .alarm-setting-card:hover {
            border-color: #2196f3;
            box-shadow: 0 2px 8px rgba(33,150,243,0.1);
        }
        .alarm-setting-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }
        .alarm-setting-title {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .alarm-input-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .alarm-input-wrapper input {
            width: 60px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
        }
        .alarm-unit {
            font-size: 13px;
            color: #7f8c8d;
        }
        .alarm-helper-text {
            font-size: 11px;
            color: #95a5a6;
            margin-top: 6px;
        }

        .alarm-info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 4px;
            font-size: 13px;
            color: #1565c0;
            line-height: 1.6;
            margin-top: 20px;
        }

        /* ========================================
           íƒ€ì„í…Œì´ë¸” ìŠ¤íƒ€ì¼ (ìµœì¢… ìˆ˜ì •)
           ======================================== */
        .timetable-container {
            display: none;
            background: white;
            margin-top: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            overflow: hidden;
            position: relative;
            min-height: 600px;
        }
        
        .timetable-header {
            display: flex;
            border-bottom: 1px solid #ddd;
            background: #f8f9fa;
            height: 40px;
            align-items: center;
        }
        
        .timetable-body {
            display: flex;
            position: relative;
            height: 1200px;
            overflow-y: auto;
            padding-top: 20px;
            box-sizing: border-box;
            background: #f8f9fa;
        }
        
        .time-column {
            width: 60px;
            flex-shrink: 0;
            border-right: 1px solid #e0e0e0;
            background: #fafafa;
            position: relative;
            z-index: 2;
        }
        
        .event-column {
            flex-grow: 1;
            position: relative;
            background-size: 100% 60px;
            background-image: 
                linear-gradient(to bottom, #e0e0e0 1px, transparent 1px), 
                linear-gradient(to bottom, transparent 30px, #f0f0f0 31px, transparent 31px);
            background-position: 0 0;
        }
        
        .time-label {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: #555;
            transform: translateY(-50%);
            font-weight: 700;
        }
        
        .time-label-sub {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 10px;
            color: #bbb;
            transform: translateY(-50%);
        }
        
        .event-block {
            position: absolute;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 13px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.1s, box-shadow 0.1s;
            z-index: 1;
            box-sizing: border-box;
            border-top: 1px solid rgba(255,255,255,0.5);
            border-right: 1px solid rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .event-block:hover {
            z-index: 10 !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: scale(1.02);
        }
        
        .event-block.meal { background: #F3E8FF; border-left-color: #9b59b6; }
        .event-block.completed { background: #f5f5f5; border-left-color: #bdc3c7; color: #95a5a6; opacity: 0.9; }
        
        .event-block.active { 
            background: #FFF9E6; 
            border-left: 4px solid #f1c40f;
            border-top: none; 
            border-right: none; 
            border-bottom: none; 
            z-index: 5; 
        }

        /* 30ë¶„ ì´í•˜ì¼ ë•Œ ìŠ¤íƒ€ì¼ ë³€ê²½ (ê°€ë¡œ ë°°ì¹˜) */
        .event-block.small-height {
            display: flex;
            align-items: center;
            padding: 0 8px;
            gap: 8px;
        }
        
        .event-block.small-height .event-time {
            margin-bottom: 0;
            white-space: nowrap;
            font-size: 12px;
        }
        
        .event-block.small-height .event-title {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            font-size: 12px;
            margin-top: 1px;
        }

        .event-time { font-size: 11px; color: inherit; opacity: 0.85; margin-bottom: 2px; display: block; font-weight: 500; }
        .event-title { font-weight: 600; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        @media (max-width: 900px){ .main-layout { flex-direction: column; } .right-panel { min-width: 0; } .memo-card { min-height: 200px; } }
        @media (max-width: 720px){ body { padding: 10px; } th, td { padding:6px; font-size:14px; } button { padding: 6px 10px; font-size: 11px; } .modal-content { padding: 20px; } .summary-bar { flex-direction: column; gap: 10px; } .card { padding: 16px; } }
    </style>
</head>
<body>
<div class="main-layout">
    <div class="left-panel">
        <div class="card">
            <h1>ğŸ“… ì—…ë¬´ì¼ì •</h1>
            <div class="row space">
                <div class="row">
                    <button class="btn-soft-pink" onclick="openTemplateModal()">ğŸ“‹ í…œí”Œë¦¿</button>
                    <button class="btn-soft-blue" onclick="openAlarmModal()">ğŸ”” ì•ŒëŒì„¤ì •</button>
                    <button class="btn-soft-orange" onclick="downloadBackup()">ğŸ’¾ ë°±ì—…</button>
                    <button class="btn-soft-violet" onclick="openRestoreModal()">ğŸ“‚ ë³µì›</button>
                    <button class="btn-soft-teal" id="timetableBtn" onclick="toggleTimetable()">ğŸ“… íƒ€ì„í…Œì´ë¸”</button>
                </div>
                <div class="spacer"></div>
                <div class="row">
                    <button class="btn-soft-violet" onclick="undoDelete()">â†©ï¸ ì‹¤í–‰ì·¨ì†Œ</button>
                    <button class="btn-soft-green" onclick="copyWorkContent()">ğŸ“‹ ì—…ë¬´ë‚´ìš©</button>
                </div>
            </div>
            
            <!-- ê¸°ì¡´ í…Œì´ë¸” ë·° -->
            <div id="tableViewWrapper">
                <table id="scheduleTable">
                    <thead>
                        <tr>
                            <th style="width:0px;">ë‹¨ìœ„</th>
                            <th style="width:0px;">ì‹œê°„</th>
                            <th style="width:24%;">ì—…ë¬´</th>
                            <th style="width:60%;">ë©”ëª¨</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>

            <!-- íƒ€ì„í…Œì´ë¸” ë·° -->
            <div id="timetableView" class="timetable-container">
                <div class="timetable-body">
                    <div class="time-column" id="timeColumn"></div>
                    <div class="event-column" id="eventColumn"></div>
                </div>
            </div>

        </div>
    </div>

    <div class="right-panel">
        <div class="card stats-card">
            <div class="card-title"><span>ğŸ“Š</span><span>ì˜¤ëŠ˜ì˜ í†µê³„</span></div>
            <div class="stat-item"><span class="stat-label">ì—…ë¬´ ì‹œê°„</span><span class="stat-value" id="statWorkTime">0ì‹œê°„ (0ê°œ)</span></div>
            <div class="stat-item"><span class="stat-label">ì™„ë£Œ ì¼ì •</span><span class="stat-value" id="statCompleted">0ì‹œê°„ (0ê°œ)</span></div>
            <div class="stat-item"><span class="stat-label">ë‚¨ì€ ì¼ì •</span><span class="stat-value" id="statRemaining">0ì‹œê°„ (0ê°œ)</span></div>
            <div class="stat-item"><span class="stat-label">ì™„ë£Œìœ¨</span><span class="stat-value" id="statProgress">0%</span></div>
        </div>
        <div class="card dday-card">
            <div class="card-title"><span>ğŸ¯</span><span>í”„ë¡œì íŠ¸ ë§ˆê°</span><button class="btn-soft-green" onclick="openAddDdayModal()" style="margin-left:auto; padding:4px 8px; font-size:11px;">+ ì¶”ê°€</button></div>
            <div id="ddayList"></div>
        </div>
        <div class="card memo-card">
            <div class="card-title">
                <span>ğŸ“</span><span>ë©”ëª¨</span>
                <div class="color-selector-inline">
                    <div class="color-option active" style="background:#FFF9E6;" data-color="#FFF9E6" onclick="setSelectedColor(this)"></div>
                    <div class="color-option" style="background:#FFE6F0;" data-color="#FFE6F0" onclick="setSelectedColor(this)"></div>
                    <div class="color-option" style="background:#E6F0FF;" data-color="#E6F0FF" onclick="setSelectedColor(this)"></div>
                    <div class="color-option" style="background:#E5F7E9;" data-color="#E5F7E9" onclick="setSelectedColor(this)"></div>
                    <div class="color-option" style="background:#F0E9FF;" data-color="#F0E9FF" onclick="setSelectedColor(this)"></div>
                </div>
            </div>
            <div class="memo-input-container"><textarea class="memo-input" id="memoInput" placeholder="" onkeydown="handleMemoKeyDown(event)"></textarea></div>
            <div class="memo-list" id="memoList"><div class="memo-empty"></div></div>
        </div>
    </div>
</div>

<!-- ëª¨ë‹¬ë“¤ -->
<div id="templateModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>ğŸ“‹ í…œí”Œë¦¿ ê´€ë¦¬</h2><span class="modal-close" onclick="closeTemplateModal()">&times;</span></div><div class="modal-body"><button class="btn-soft-green" onclick="openSaveTemplateModal()" style="width:100%; margin-bottom:20px;">ğŸ’¾ í˜„ì¬ ì¼ì •ì„ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥</button><div id="templateList"></div></div></div></div>
<div id="saveTemplateModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>ğŸ’¾ í…œí”Œë¦¿ ì €ì¥</h2><span class="modal-close" onclick="closeSaveTemplateModal()">&times;</span></div><div class="modal-body"><div class="form-group"><label>í…œí”Œë¦¿ ì´ë¦„</label><input type="text" id="templateName" placeholder="ì˜ˆ: í‰ì¼ ë£¨í‹´" /></div></div><div class="modal-footer"><button class="btn-soft-orange" onclick="closeSaveTemplateModal()">ì·¨ì†Œ</button><button class="btn-soft-green" onclick="saveTemplate()">ì €ì¥</button></div></div></div>

<!-- ê°œì„ ëœ ì•ŒëŒ ì„¤ì • ëª¨ë‹¬ -->
<div id="alarmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ”” ì•ŒëŒ ì„¤ì •</h2>
            <span class="modal-close" onclick="closeAlarmModal()">&times;</span>
        </div>
        <div class="modal-body">
            <!-- ë©”ì¸ ìŠ¤ìœ„ì¹˜ -->
            <div class="alarm-header-switch">
                <div class="switch-label">
                    <span>ğŸ”” ì•ŒëŒ í™œì„±í™”</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="alarmEnabled" onchange="toggleAlarm(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            
            <!-- ì„¤ì • ì¹´ë“œ ê·¸ë£¹ -->
            <div class="alarm-settings-group">
                <!-- ì‹œì‘ ì•ŒëŒ ì„¤ì • -->
                <div class="alarm-setting-card">
                    <span class="alarm-setting-icon">ğŸ¬</span>
                    <div class="alarm-setting-title">ì‹œì‘ ì•Œë¦¼</div>
                    <div class="alarm-input-wrapper">
                        <input type="number" id="alarmStartMinutes" value="0" min="0" max="60" onchange="saveAlarmSettings()">
                        <span class="alarm-unit">ë¶„ ì „</span>
                    </div>
                    <div class="alarm-helper-text">0ë¶„: ì •ì‹œ ì•Œë¦¼</div>
                </div>

                <!-- ì¢…ë£Œ ì•ŒëŒ ì„¤ì • -->
                <div class="alarm-setting-card">
                    <span class="alarm-setting-icon">ğŸ</span>
                    <div class="alarm-setting-title">ì¢…ë£Œ ì•Œë¦¼</div>
                    <div class="alarm-input-wrapper">
                        <input type="number" id="alarmEndMinutes" value="5" min="1" max="60" onchange="saveAlarmSettings()">
                        <span class="alarm-unit">ë¶„ ì „</span>
                    </div>
                    <div class="alarm-helper-text">ì¢…ë£Œ ì „ ë¯¸ë¦¬ ì•Œë¦¼</div>
                </div>
            </div>

            <button class="btn-soft-blue" onclick="testAlarm()" style="width:100%; padding:12px; font-size:14px; border-radius:8px;">ğŸ”” ì•ŒëŒ í…ŒìŠ¤íŠ¸</button>
            
            <div class="alarm-info-box">
                ğŸ’¡ <b>ì•ŒëŒì´ ìš¸ë¦¬ì§€ ì•Šë‚˜ìš”?</b><br>
                â€¢ ë¸Œë¼ìš°ì €ì˜ ì•Œë¦¼ ê¶Œí•œì„ 'í—ˆìš©'í•´ì£¼ì„¸ìš”.<br>
                â€¢ ë°©í•´ ê¸ˆì§€ ëª¨ë“œê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.<br>
                â€¢ ì°½ì„ ë‹«ì§€ ì•Šê³  ì¼œë‘ì…”ì•¼ ì•Œë¦¼ì´ ì‘ë™í•©ë‹ˆë‹¤.
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-soft-green" onclick="closeAlarmModal()">í™•ì¸</button>
        </div>
    </div>
</div>

<div id="restoreModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>ğŸ“‚ ë°ì´í„° ë³µì›</h2><span class="modal-close" onclick="closeRestoreModal()">&times;</span></div><div class="modal-body"><div class="form-group"><label>ğŸ“ íŒŒì¼ì—ì„œ ë³µì›</label><input type="file" id="restoreFile" accept=".json" onchange="restoreFromFile(this)" style="padding:10px; background:#f8f9fa; border-radius:8px;"></div><div class="form-group" style="margin-top:30px;"><label>ğŸ• ìë™ ë°±ì—…ì—ì„œ ë³µì›</label><div id="autoBackupList" style="max-height:300px; overflow-y:auto;"></div></div></div><div class="modal-footer"><button class="btn-soft-orange" onclick="closeRestoreModal()">ë‹«ê¸°</button></div></div></div>
<div id="addDdayModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>ğŸ¯ ë””ë°ì´ ì¶”ê°€</h2><span class="modal-close" onclick="closeAddDdayModal()">&times;</span></div><div class="modal-body"><div class="form-group"><label>í”„ë¡œì íŠ¸ ì´ë¦„</label><input type="text" id="ddayTitle" placeholder="" /></div><div class="form-group"><label>ë§ˆê°ì¼</label><input type="date" id="ddayDate" /></div></div><div class="modal-footer"><button class="btn-soft-orange" onclick="closeAddDdayModal()">ì·¨ì†Œ</button><button class="btn-soft-green" onclick="saveDday()">ì¶”ê°€</button></div></div></div>

<script>
/* ------------------------------
   ì „ì—­ ìƒíƒœ
------------------------------ */
let schedules = [];
let templates = [];
let draggedIndex = null;
let dragSource = null; 
// ì•ŒëŒ ì„¤ì • êµ¬ì¡° ë³€ê²½: startMinutes ì¶”ê°€
let alarmSettings = { enabled: false, startMinutes: 0, endMinutes: 5 };
let notifiedTasks = new Set();
let alarmCheckInterval = null;
let deletedHistory = [];
let memos = [];
let selectedMemoColor = '#FFF9E6';
let draggedMemoIndex = null;
let ddays = [];
const START_TIME = "9:00";
const WINDOW = 0.05;
let isTimetableMode = false;

/* ------------------------------
   ê³µí†µ ìœ í‹¸
------------------------------ */
function parseTime(t){ const [h, m] = t.split(':').map(Number); return h + m/60; }

function formatTime(h){
    const hours = Math.floor(h);
    const minutes = Math.round((h - hours) * 60);
    let displayHour = hours % 12; 
    if(displayHour === 0) displayHour = 12;
    return `${displayHour}:${minutes.toString().padStart(2,'0')}`;
}

function to12Hour(h) {
    const hour = Math.floor(h);
    const mins = Math.round((h - hour) * 60);
    let displayH = hour % 12;
    if(displayH === 0) displayH = 12;
    return { h: displayH, m: mins.toString().padStart(2,'0') };
}

function nowInHours(){ const n = new Date(); return n.getHours() + n.getMinutes()/60; }

function formatHours(totalHours){
    const hours = Math.floor(totalHours);
    const minutes = Math.round((totalHours - hours) * 60);
    if(hours > 0 && minutes > 0) return `${hours}ì‹œê°„ ${minutes}ë¶„`;
    else if(hours > 0) return `${hours}ì‹œê°„`;
    else if(minutes > 0) return `${minutes}ë¶„`;
    else return `0ì‹œê°„`;
}

function createSchedule(duration = 1, task = '', completed = false){
    return { id: Date.now() + Math.random(), duration, task, memo: '', completed, start: '', end: '', startNum: 0, endNum: 0 };
}

function ensureScheduleIds(){
    schedules.forEach(s => {
        if(!s.id) s.id = Date.now() + Math.random();
        if(s.memo === undefined) s.memo = '';
    });
}

/* ------------------------------
   ë°ì´í„° ë¡œë“œ/ì €ì¥
------------------------------ */
function loadData(){
    const saved = localStorage.getItem('scheduleData');
    const savedTemplates = localStorage.getItem('templates');
    const savedAlarmSettings = localStorage.getItem('alarmSettings');
    const savedMemos = localStorage.getItem('dailyMemos');
    const savedDdays = localStorage.getItem('ddays');
    
    if(saved){ schedules = JSON.parse(saved); } else { schedules = [ createSchedule(1, '', false) ]; }
    ensureScheduleIds();
    if(savedTemplates){ templates = JSON.parse(savedTemplates); }
    
    // ì•ŒëŒ ì„¤ì • ë¡œë“œ ë° ë§ˆì´ê·¸ë ˆì´ì…˜
    if(savedAlarmSettings){
        const parsed = JSON.parse(savedAlarmSettings);
        // êµ¬ë²„ì „ í˜¸í™˜ì„± ì²˜ë¦¬ (minutesBefore -> endMinutes)
        if(parsed.minutesBefore !== undefined && parsed.endMinutes === undefined) {
            alarmSettings = { 
                enabled: parsed.enabled, 
                startMinutes: 0, 
                endMinutes: parsed.minutesBefore 
            };
        } else {
            alarmSettings = parsed;
        }
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('alarmEnabled').checked = alarmSettings.enabled;
        document.getElementById('alarmStartMinutes').value = alarmSettings.startMinutes || 0;
        document.getElementById('alarmEndMinutes').value = alarmSettings.endMinutes || 5;
    }
    
    if(savedMemos){ memos = JSON.parse(savedMemos); }
    if(savedDdays){ ddays = JSON.parse(savedDdays); }
    
    ensureDailyReset();
    checkAndCreateAutoBackup();
    renderMemos();
    renderDdays();
    renderTable();
    initAlarmSystem();
    updateStats();
}

function saveData(){
    localStorage.setItem('scheduleData', JSON.stringify(schedules));
    localStorage.setItem('templates', JSON.stringify(templates));
    localStorage.setItem('alarmSettings', JSON.stringify(alarmSettings));
    localStorage.setItem('dailyMemos', JSON.stringify(memos));
    localStorage.setItem('ddays', JSON.stringify(ddays));
}

/* ------------------------------
   ë©”ëª¨, ë””ë°ì´ ê´€ë ¨ ìƒëµ (ê¸°ì¡´ ìœ ì§€)
------------------------------ */
function setSelectedColor(element){
    document.querySelectorAll('.color-selector-inline .color-option').forEach(opt => opt.classList.remove('active'));
    element.classList.add('active');
    selectedMemoColor = element.dataset.color;
}
function handleMemoKeyDown(event){ if(event.key === 'Enter' && !event.shiftKey){ event.preventDefault(); addMemoItem(); } }
function addMemoItem(){
    const input = document.getElementById('memoInput');
    const text = input.value.trim();
    if(!text) return;
    memos.unshift({ id: Date.now(), text, color: selectedMemoColor, createdAt: new Date().toISOString() });
    input.value = ''; input.focus(); saveData(); renderMemos();
}
function deleteMemoItem(id){ memos = memos.filter(m => m.id !== id); saveData(); renderMemos(); }
function renderMemos(){
    const container = document.getElementById('memoList'); container.innerHTML = '';
    if(memos.length === 0){ container.innerHTML = '<div class="memo-empty"></div>'; return; }
    memos.forEach((memo, index) => {
        const div = document.createElement('div'); div.className = 'memo-item'; div.draggable = true; div.dataset.memoIndex = index; div.style.background = memo.color;
        div.appendChild(document.createTextNode(memo.text));
        const deleteBtn = document.createElement('button'); deleteBtn.className = 'memo-delete'; deleteBtn.textContent = 'Ã—';
        deleteBtn.addEventListener('click', function(e) { e.stopPropagation(); deleteMemoItem(memo.id); });
        div.appendChild(deleteBtn);
        div.addEventListener('dragstart', function(e) { draggedMemoIndex = index; dragSource = 'memo'; div.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
        div.addEventListener('dragover', function(e) { e.preventDefault(); });
        div.addEventListener('drop', function(e) {
            e.preventDefault(); e.stopPropagation(); if(dragSource !== 'memo') return;
            const dropIndex = parseInt(div.dataset.memoIndex, 10);
            if(draggedMemoIndex === null || draggedMemoIndex === dropIndex) return;
            const memoItem = memos.splice(draggedMemoIndex, 1)[0];
            memos.splice(draggedMemoIndex < dropIndex ? dropIndex : dropIndex, 0, memoItem);
            saveData(); renderMemos();
        });
        div.addEventListener('dragend', function() { container.querySelectorAll('.memo-item').forEach(item => item.classList.remove('dragging')); draggedMemoIndex = null; dragSource = null; });
        container.appendChild(div);
    });
    const tail = document.createElement('div'); tail.style.height = '0px'; 
    tail.addEventListener('dragover', function(e){ e.preventDefault(); });
    tail.addEventListener('drop', function(e){
        e.preventDefault(); if(dragSource !== 'memo' || draggedMemoIndex === null) return;
        const memoItem = memos.splice(draggedMemoIndex, 1)[0]; memos.push(memoItem); saveData(); renderMemos();
    });
    container.appendChild(tail);
}
function renderDdays(){
    const container = document.getElementById('ddayList');
    if(ddays.length === 0){ container.innerHTML = '<div class="memo-empty"></div>'; return; }
    const today = new Date(); today.setHours(0, 0, 0, 0);
    const sortedDdays = ddays.map(d => {
        const deadline = new Date(d.date); deadline.setHours(0, 0, 0, 0);
        const diffTime = deadline - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return { ...d, diffDays };
    }).sort((a, b) => a.diffDays - b.diffDays);
    container.innerHTML = sortedDdays.map(d => {
        let badgeClass = 'dday-normal'; let badgeText = `D-${d.diffDays}`;
        if(d.diffDays < 0){ badgeClass = 'dday-passed'; badgeText = `D+${Math.abs(d.diffDays)}`; }
        else if(d.diffDays === 0){ badgeClass = 'dday-today'; badgeText = 'D-Day'; }
        else if(d.diffDays <= 3){ badgeClass = 'dday-urgent'; }
        else if(d.diffDays <= 7){ badgeClass = 'dday-soon'; }
        return `<div class="dday-item"><span class="dday-title" title="${d.title}">${d.title}</span><div style="display:flex; align-items:center; gap:4px;"><span class="dday-badge ${badgeClass}">${badgeText}</span><button class="dday-delete" onclick="deleteDday(${d.id})">Ã—</button></div></div>`;
    }).join('');
}
function openAddDdayModal(){ document.getElementById('ddayTitle').value = ''; document.getElementById('ddayDate').value = ''; document.getElementById('addDdayModal').classList.add('show'); }
function closeAddDdayModal(){ document.getElementById('addDdayModal').classList.remove('show'); }
function saveDday(){
    const title = document.getElementById('ddayTitle').value.trim(); const date = document.getElementById('ddayDate').value;
    if(!title || !date) return; addDday(title, date); closeAddDdayModal();
}
function deleteDday(id){ ddays = ddays.filter(d => d.id !== id); saveData(); renderDdays(); }
function addDday(title, date){ ddays.push({ id: Date.now(), title, date }); saveData(); renderDdays(); }

/* ------------------------------
   ì¼ì • ê³„ì‚° / ë Œë”ë§
------------------------------ */
function calculateTimes(){
    let cur = parseTime(START_TIME);
    schedules.forEach(s => { 
        s.start = formatTime(cur); 
        s.startNum = cur; 
        cur += s.duration; 
        s.end = formatTime(cur); 
        s.endNum = cur; 
    });
}

function createRowElement(s, i) {
    const tr = document.createElement('tr');
    tr.draggable = true; tr.dataset.index = i; tr.dataset.id = s.id;
    const isMeal = /ì ì‹¬|ì ì‹¬ì‹ì‚¬|ì €ë…|ì €ë…ì‹ì‚¬/i.test(s.task);
    if(isMeal) tr.classList.add('meal-row');
    if(s.completed) tr.classList.add('completed-row');

    const d = document.createElement('td'); d.className = 'duration-cell'; 
    const durationInput = document.createElement('input'); durationInput.type = 'number'; durationInput.step = '0.5'; durationInput.value = s.duration;
    durationInput.addEventListener('change', function() { s.duration = parseFloat(this.value) || 0.5; calculateTimes(); saveData(); updateStats(); updateTimeDisplay(); });
    d.appendChild(durationInput); tr.appendChild(d);
    
    const t = document.createElement('td'); t.className = 'time-cell'; t.textContent = `${s.start} - ${s.end}`; tr.appendChild(t);
    
    const task = document.createElement('td'); task.className = 'task-cell';
    const textarea = document.createElement('textarea'); textarea.className = 'task-input'; textarea.value = s.task || ''; textarea.rows = 1;
    const autoResize = () => { textarea.style.height = '1px'; textarea.style.height = textarea.scrollHeight + 'px'; };
    textarea.addEventListener('input', function() { s.task = this.value; autoResize(); const isMeal = /ì ì‹¬|ì ì‹¬ì‹ì‚¬|ì €ë…|ì €ë…ì‹ì‚¬/i.test(s.task); if(isMeal) tr.classList.add('meal-row'); else tr.classList.remove('meal-row'); });
    textarea.addEventListener('blur', function() { s.task = this.value; saveData(); });
    setTimeout(autoResize, 0);
    textarea.addEventListener('keydown', handleRowKeydown);
    task.appendChild(textarea); tr.appendChild(task);
    
    const memoCell = document.createElement('td'); memoCell.className = 'task-cell';
    const memoTextarea = document.createElement('textarea'); memoTextarea.className = 'memo-input-cell'; memoTextarea.value = s.memo || ''; memoTextarea.rows = 1;
    const autoResizeMemo = () => { memoTextarea.style.height = '1px'; memoTextarea.style.height = memoTextarea.scrollHeight + 'px'; };
    memoTextarea.addEventListener('input', function() { s.memo = this.value; autoResizeMemo(); });
    memoTextarea.addEventListener('blur', function() { s.memo = this.value; saveData(); });
    memoTextarea.addEventListener('keydown', handleRowKeydown);
    setTimeout(autoResizeMemo, 0);
    memoCell.appendChild(memoTextarea); tr.appendChild(memoCell);
    
    tr.addEventListener('dragstart', handleDragStart); tr.addEventListener('dragover', handleDragOver); tr.addEventListener('drop', handleDrop); tr.addEventListener('dragend', handleDragEnd);
    return tr;
}

function renderTable(){
    calculateTimes();
    const tbody = document.getElementById('scheduleBody'); tbody.innerHTML = ''; updateStats();
    schedules.forEach((s, i) => { tbody.appendChild(createRowElement(s, i)); });
    if(isTimetableMode) renderTimetable();
}

/* ------------------------------
   íƒ€ì„í…Œì´ë¸” ë¡œì§ (ê°œì„ ë¨ - ê²¹ì¹¨ ì²˜ë¦¬ + 12ì‹œê°„ì œ + ìŠ¤íƒ€ì¼ ìˆ˜ì •)
------------------------------ */
function toggleTimetable() {
    isTimetableMode = !isTimetableMode;
    const tableWrap = document.getElementById('tableViewWrapper');
    const timetableWrap = document.getElementById('timetableView');
    const btn = document.getElementById('timetableBtn');

    if (isTimetableMode) {
        calculateTimes();
        tableWrap.style.display = 'none';
        timetableWrap.style.display = 'block';
        btn.textContent = 'ğŸ“‹ ë¦¬ìŠ¤íŠ¸ ë³´ê¸°';
        btn.classList.remove('btn-soft-teal');
        btn.classList.add('btn-soft-orange');
        renderTimetable();
    } else {
        tableWrap.style.display = 'block';
        timetableWrap.style.display = 'none';
        btn.textContent = 'ğŸ“… íƒ€ì„í…Œì´ë¸”';
        btn.classList.remove('btn-soft-orange');
        btn.classList.add('btn-soft-teal');
    }
}

function renderTimetable() {
    const timeCol = document.getElementById('timeColumn');
    const eventCol = document.getElementById('eventColumn');
    timeCol.innerHTML = ''; eventCol.innerHTML = '';
    
    const hourHeight = 60; 
    const startHour = Math.floor(parseTime(START_TIME));
    
    let maxEnd = startHour + 12;
    schedules.forEach(s => { if(s.endNum > maxEnd) maxEnd = Math.ceil(s.endNum); });
    maxEnd += 1;

    // ì‹œê°„ ë¼ë²¨
    for (let h = startHour; h <= maxEnd; h++) {
        const label = document.createElement('div');
        label.className = 'time-label';
        label.style.top = `${(h - startHour) * hourHeight}px`;
        const t12 = to12Hour(h);
        label.textContent = `${t12.h}:00`;
        timeCol.appendChild(label);
        
        const subLabel = document.createElement('div');
        subLabel.className = 'time-label-sub';
        subLabel.style.top = `${(h - startHour) * hourHeight + 30}px`; 
        subLabel.textContent = `${t12.h}:30`;
        timeCol.appendChild(subLabel);
    }

    const nowH = nowInHours();

    const sortedEvents = schedules.map((s, i) => ({...s, originalIndex: i})).sort((a, b) => a.startNum - b.startNum);
    const columns = [];

    sortedEvents.forEach(ev => {
        let placed = false;
        for(let i = 0; i < columns.length; i++) {
            const col = columns[i];
            const lastInCol = col[col.length - 1];
            if (lastInCol.endNum <= ev.startNum) {
                col.push(ev); ev.colIndex = i; placed = true; break;
            }
        }
        if (!placed) { columns.push([ev]); ev.colIndex = columns.length - 1; }
    });

    sortedEvents.forEach(s => {
        const div = document.createElement('div');
        div.className = 'event-block';
        
        const top = (s.startNum - startHour) * hourHeight;
        const height = s.duration * hourHeight;
        
        let maxColIndex = 0;
        sortedEvents.forEach(other => {
            if (s.id !== other.id && !(other.endNum <= s.startNum || other.startNum >= s.endNum)) {
                if (other.colIndex > maxColIndex) maxColIndex = other.colIndex;
            }
        });
        if (s.colIndex > maxColIndex) maxColIndex = s.colIndex;
        
        const totalCols = maxColIndex + 1;
        const widthPercent = 100 / totalCols;
        const leftPercent = s.colIndex * widthPercent;

        div.style.top = `${top}px`;
        div.style.height = `${height - 1}px`;
        div.style.left = `${leftPercent}%`;
        div.style.width = `${widthPercent}%`;
        
        const isMeal = /ì ì‹¬|ì ì‹¬ì‹ì‚¬|ì €ë…|ì €ë…ì‹ì‚¬/i.test(s.task);
        if(isMeal) div.classList.add('meal');
        if(s.completed) div.classList.add('completed');
        if(nowH >= s.startNum && nowH < s.endNum) div.classList.add('active');
        
        if (s.duration <= 0.5) {
            div.classList.add('small-height');
        }

        const start12 = to12Hour(s.startNum);
        const end12 = to12Hour(s.endNum);
        const timeStr = `${start12.h}:${start12.m} - ${end12.h}:${end12.m}`;

        div.innerHTML = `
            <span class="event-time">${timeStr}</span>
            <span class="event-title">${s.task || '(ë‚´ìš© ì—†ìŒ)'}</span>
        `;
        
        div.onclick = () => {
            toggleTimetable();
            setTimeout(() => {
                const rows = document.querySelectorAll('#scheduleBody tr');
                if(rows[s.originalIndex]) {
                    rows[s.originalIndex].scrollIntoView({behavior: 'smooth', block: 'center'});
                    rows[s.originalIndex].classList.add('active');
                    setTimeout(()=>rows[s.originalIndex].classList.remove('active'), 2000);
                }
            }, 100);
        };
        
        eventCol.appendChild(div);
    });
}

function handleRowKeydown(e) {
    const target = e.target;
    const tr = target.closest('tr');
    const tbody = tr.parentNode;
    const i = Array.from(tbody.children).indexOf(tr);
    const s = schedules[i];
    const isTaskInput = target.classList.contains('task-input');

    if(e.shiftKey && e.key === 'Enter'){ return; }
    if(isTaskInput && e.ctrlKey && ['=','-','1','2','3','4'].includes(e.key)){
        e.preventDefault();
        if(e.key === '=') s.duration = Math.min(24, s.duration + 0.5);
        else if(e.key === '-') s.duration = Math.max(0.5, s.duration - 0.5);
        else s.duration = {'1':0.5,'2':1,'3':2,'4':3}[e.key];
        calculateTimes(); saveData(); updateStats(); updateTimeDisplay(); setTimeout(() => target.focus(), 10); return;
    }
    if(isTaskInput && e.altKey && (e.key === 'ArrowUp' || e.key === 'ArrowDown')){
        e.preventDefault(); s.task = target.value;
        if(e.key === 'ArrowUp' && i > 0){ [schedules[i - 1], schedules[i]] = [schedules[i], schedules[i - 1]]; const prevRow = tr.previousElementSibling; tbody.insertBefore(tr, prevRow); updateIndices(i-1); } 
        else if(e.key === 'ArrowDown' && i < schedules.length - 1){ [schedules[i], schedules[i + 1]] = [schedules[i + 1], schedules[i]]; const nextRow = tr.nextElementSibling; tbody.insertBefore(nextRow, tr); updateIndices(i); } 
        calculateTimes(); updateTimeDisplay(); saveData(); target.focus(); return;
    }
    if(isTaskInput && e.ctrlKey && e.key === 'd'){
        e.preventDefault(); s.task = target.value; const newSchedule = createSchedule(s.duration, s.task, false); if(s.memo) newSchedule.memo = s.memo;
        schedules.splice(i + 1, 0, newSchedule); ensureScheduleIds(); calculateTimes(); saveData();
        const newRow = createRowElement(newSchedule, i + 1); if(i + 1 >= tbody.children.length) tbody.appendChild(newRow); else tbody.insertBefore(newRow, tbody.children[i+1]);
        updateIndices(i); updateStats(); setTimeout(() => { const input = newRow.querySelector('.task-input'); if(input) { input.focus(); input.setSelectionRange(0, 0); } }, 20); return;
    }
    if(e.ctrlKey && e.key === 'Backspace'){
        e.preventDefault(); if(schedules.length === 1) return; deletedHistory.push({ index: i, data: JSON.parse(JSON.stringify(s)) });
        schedules.splice(i, 1); tr.remove(); ensureScheduleIds(); calculateTimes(); saveData(); updateIndices(i); updateStats();
        setTimeout(() => { const rows = tbody.querySelectorAll('tr'); const nextIdx = Math.min(i, rows.length - 1); if(rows[nextIdx]){ const input = rows[nextIdx].querySelector('.task-input'); if(input) input.focus(); } }, 20); return;
    }
    if(e.ctrlKey && e.key === 'Enter'){
        e.preventDefault(); if(isTaskInput) s.task = target.value; else s.memo = target.value; const newSchedule = createSchedule(1, '', false);
        schedules.splice(i + 1, 0, newSchedule); ensureScheduleIds(); calculateTimes(); saveData();
        const newRow = createRowElement(newSchedule, i + 1); if(i + 1 >= tbody.children.length) tbody.appendChild(newRow); else tbody.insertBefore(newRow, tbody.children[i+1]);
        updateIndices(i); updateStats(); setTimeout(() => { const input = newRow.querySelector('.task-input'); if(input) input.focus(); }, 20); return;
    }
    if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault(); if(isTaskInput) s.task = target.value; else s.memo = target.value; saveData();
        const nextRow = tr.nextElementSibling; if(nextRow) { const input = isTaskInput ? nextRow.querySelector('.task-input') : nextRow.querySelector('.memo-input-cell'); if(input) input.focus(); } return;
    }
    if(!e.altKey && !e.ctrlKey) {
        if(e.key === 'ArrowDown'){ const nextRow = tr.nextElementSibling; if(nextRow){ const input = isTaskInput ? nextRow.querySelector('.task-input') : nextRow.querySelector('.memo-input-cell'); if(input) input.focus(); } }
        else if(e.key === 'ArrowUp'){ const prevRow = tr.previousElementSibling; if(prevRow){ const input = isTaskInput ? prevRow.querySelector('.task-input') : prevRow.querySelector('.memo-input-cell'); if(input) input.focus(); } }
        if(!isTaskInput && e.key === 'ArrowLeft' && target.selectionStart === 0){ e.preventDefault(); s.memo = target.value; saveData(); const taskInput = tr.querySelector('.task-input'); if(taskInput){ taskInput.focus(); taskInput.selectionStart = taskInput.value.length; taskInput.selectionEnd = taskInput.value.length; } }
    }
}

function updateIndices(startIndex = 0) { const rows = document.querySelectorAll('#scheduleBody tr'); for(let k = 0; k < rows.length; k++){ rows[k].dataset.index = k; } updateTimeDisplay(); }
function handleDragStart(e){ draggedIndex = parseInt(this.dataset.index, 10); dragSource = 'schedule'; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
function handleDragOver(e){ if(e.preventDefault) e.preventDefault(); if(dragSource !== 'schedule') return; e.dataTransfer.dropEffect = 'move'; this.classList.add('drag-over'); return false; }
function handleDrop(e){ if(e.stopPropagation) e.stopPropagation(); if(dragSource !== 'schedule') return; const dropIndex = parseInt(this.dataset.index, 10); if(draggedIndex !== dropIndex){ const item = schedules.splice(draggedIndex, 1)[0]; schedules.splice(dropIndex, 0, item); updateAllTimes(); } return false; }
function handleDragEnd(e){ document.querySelectorAll('#scheduleBody tr').forEach(tr => { tr.classList.remove('dragging', 'drag-over'); }); dragSource = null; }
function deleteRowById(rowId){ const index = schedules.findIndex(s => s.id === rowId); if(index === -1) return; if(schedules.length === 1) return; deletedHistory.push({ index, data: JSON.parse(JSON.stringify(schedules[index])) }); schedules.splice(index, 1); ensureScheduleIds(); calculateTimes(); saveData(); renderTable(); setTimeout(() => { const inputs = document.querySelectorAll('.task-input'); const focusIndex = Math.min(index, inputs.length - 1); if(inputs[focusIndex]) inputs[focusIndex].focus(); }, 20); }
function undoDelete(){ if(deletedHistory.length === 0) return; const last = deletedHistory.pop(); const insertIndex = Math.min(last.index, schedules.length); schedules.splice(insertIndex, 0, last.data); ensureScheduleIds(); calculateTimes(); saveData(); renderTable(); setTimeout(() => { const inputs = document.querySelectorAll('.task-input'); if(inputs[insertIndex]) inputs[insertIndex].focus(); }, 20); }
function copyWorkContent(){ let content = ''; schedules.forEach(s => { const isMeal = /ì ì‹¬|ì ì‹¬ì‹ì‚¬|ì €ë…|ì €ë…ì‹ì‚¬|íšŒì˜/i.test(s.task); if(!isMeal && s.task.trim()) content += `- ${s.task}(${s.duration}ì‹œê°„)\n`; }); if(!content) return; navigator.clipboard.writeText(content).catch(err => console.error('ë³µì‚¬ ì‹¤íŒ¨:', err)); }
function updateAllTimes(){ ensureScheduleIds(); calculateTimes(); renderTable(); saveData(); }
function updateTimeDisplay(){ const allRows = document.querySelectorAll('#scheduleBody tr'); allRows.forEach((row, idx) => { const sch = schedules[idx]; if(sch) { const timeCell = row.querySelector('.time-cell'); const durationInput = row.querySelector('.duration-cell input'); if(timeCell) timeCell.textContent = `${sch.start} - ${sch.end}`; if(durationInput && document.activeElement !== durationInput) durationInput.value = sch.duration; } }); }
function updateRowStyles() { const nowH = nowInHours(); let needSave = false; const rows = document.querySelectorAll('#scheduleBody tr'); schedules.forEach((s, i) => { let changed = false; if(nowH < s.startNum && s.completed) { s.completed = false; changed = true; } if(nowH >= s.startNum && nowH < s.endNum && s.completed) { s.completed = false; changed = true; } if(nowH >= s.endNum && !s.completed) { s.completed = true; changed = true; } if(changed) needSave = true; const tr = rows[i]; if(!tr) return; if(nowH >= s.startNum && nowH < s.endNum) tr.classList.add('active'); else tr.classList.remove('active'); if(s.completed) tr.classList.add('completed-row'); else tr.classList.remove('completed-row'); }); if(needSave) saveData(); }
function updateStats(){ const nowH = nowInHours(); let allHours = 0, allCount = schedules.length; let remainingHours = 0, remainingCount = 0; let completedHours = 0, completedCount = 0; let wholeCompletedHours = 0; schedules.forEach(s => { const isMeal = /ì ì‹¬|ì ì‹¬ì‹ì‚¬|ì €ë…|ì €ë…ì‹ì‚¬|ì‹ì‚¬/i.test(s.task); allHours += s.duration; if(s.completed) wholeCompletedHours += s.duration; if(nowH < s.endNum){ remainingHours += s.duration; remainingCount++; } if(s.completed && !isMeal){ completedHours += s.duration; completedCount++; } }); const progressPercent = allHours > 0 ? Math.round((wholeCompletedHours / allHours) * 100) : 0; document.getElementById('statWorkTime').textContent = `${formatHours(allHours)} (${allCount}ê°œ)`; document.getElementById('statCompleted').textContent = `${formatHours(completedHours)} (${completedCount}ê°œ)`; document.getElementById('statRemaining').textContent = `${formatHours(remainingHours)} (${remainingCount}ê°œ)`; document.getElementById('statProgress').textContent = `${progressPercent}%`; }
function ensureDailyReset(){ const today = new Date().toDateString(); const last = localStorage.getItem('lastReset'); if(last !== today){ schedules.forEach(s => { s.completed = false; }); localStorage.setItem('lastReset', today); notifiedTasks.clear(); saveData(); renderTable(); } }
function openTemplateModal(){ renderTemplateList(); document.getElementById('templateModal').classList.add('show'); }
function closeTemplateModal(){ document.getElementById('templateModal').classList.remove('show'); }
function openSaveTemplateModal(){ document.getElementById('templateName').value = ''; document.getElementById('saveTemplateModal').classList.add('show'); }
function closeSaveTemplateModal(){ document.getElementById('saveTemplateModal').classList.remove('show'); }
function saveTemplate(){ const name = document.getElementById('templateName').value.trim(); if(!name){ alert('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; } templates.push({ id: Date.now(), name: name, schedules: JSON.parse(JSON.stringify(schedules)), createdAt: new Date().toISOString() }); saveData(); closeSaveTemplateModal(); renderTemplateList(); alert('í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!'); }
function renderTemplateList(){ const container = document.getElementById('templateList'); if(templates.length === 0){ container.innerHTML = '<p style="color:#7f8c8d; text-align:center;">ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; } container.innerHTML = templates.map((t, i) => `<div class="template-item" onclick="loadTemplate(${i})"><div class="template-name">${t.name}</div><div class="template-info">${t.schedules.length}ê°œ ì¼ì • Â· ${new Date(t.createdAt).toLocaleDateString()}<button class="btn-danger" onclick="event.stopPropagation(); deleteTemplate(${i})" style="float:right; padding:4px 8px; font-size:11px;">ì‚­ì œ</button></div></div>`).join(''); }
function loadTemplate(index){ if(confirm('í˜„ì¬ ì¼ì •ì„ í…œí”Œë¦¿ìœ¼ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ const template = templates[index]; schedules = JSON.parse(JSON.stringify(template.schedules)); ensureScheduleIds(); updateAllTimes(); closeTemplateModal(); alert('í…œí”Œë¦¿ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!'); } }
function deleteTemplate(index){ if(confirm('ì´ í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ templates.splice(index, 1); saveData(); renderTemplateList(); } }

async function initAlarmSystem(){ if('Notification' in window && Notification.permission === 'default'){ await Notification.requestPermission(); } if(alarmSettings.enabled) startAlarmCheck(); }
function startAlarmCheck(){ if(alarmCheckInterval) clearInterval(alarmCheckInterval); alarmCheckInterval = setInterval(() => { checkAndNotify(nowInHours()); }, 10000); checkAndNotify(nowInHours()); }
function stopAlarmCheck(){ if(alarmCheckInterval){ clearInterval(alarmCheckInterval); alarmCheckInterval = null; } }

function checkAndNotify(nowH){ 
    if(!alarmSettings.enabled || Notification.permission !== 'granted') return; 
    calculateTimes(); 
    
    schedules.forEach((s) => { 
        if(s.completed) return; 
        const startKey = `start-${s.id}`; 
        const endKey = `end-${s.id}`; 
        
        // ì‹œì‘ ì•Œë¦¼ ê³„ì‚° (ì„¤ì •ëœ ë¶„ë§Œí¼ ë¯¸ë¦¬)
        const startAlarmTime = s.startNum - (alarmSettings.startMinutes / 60);
        
        if(nowH >= startAlarmTime && nowH < startAlarmTime + WINDOW && !notifiedTasks.has(startKey)){ 
            notifiedTasks.add(startKey); 
            showStartNotification(s); 
        } 
        
        // ì¢…ë£Œ ì•Œë¦¼ ê³„ì‚° (ì„¤ì •ëœ ë¶„ë§Œí¼ ë¯¸ë¦¬)
        const endAlarmTime = s.endNum - (alarmSettings.endMinutes / 60);
        
        if(nowH >= endAlarmTime && nowH < endAlarmTime + WINDOW && !notifiedTasks.has(endKey)){ 
            notifiedTasks.add(endKey); 
            showEndNotification(s); 
        } 
    }); 
}

function showStartNotification(currentTask){ 
    const timeText = alarmSettings.startMinutes > 0 ? `${alarmSettings.startMinutes}ë¶„ ì „` : 'ì§€ê¸ˆ ì‹œì‘';
    const notification = new Notification(`ğŸ¬ ${timeText}: ${currentTask.task || 'í• ì¼'}`, { 
        body: `[ì‹œì‘] ${currentTask.start} - ${currentTask.end}`, 
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">ğŸ¬</text></svg>', 
        tag: 'schedule-start-' + Date.now(), 
        requireInteraction: true, 
        silent: false 
    }); 
    notification.onclick = function(){ window.focus(); this.close(); }; 
}

function showEndNotification(currentTask){ 
    const notification = new Notification(`âŒ› ì¢…ë£Œ ${alarmSettings.endMinutes}ë¶„ ì „: ${currentTask.task || 'í• ì¼'}`, { 
        body: `[ì¢…ë£Œ ì„ë°•] ${currentTask.start} - ${currentTask.end}`, 
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">âŒ›</text></svg>', 
        tag: 'schedule-end-' + Date.now(), 
        requireInteraction: true, 
        silent: false 
    }); 
    notification.onclick = function(){ window.focus(); this.close(); }; 
}

function openAlarmModal(){ document.getElementById('alarmModal').classList.add('show'); }
function closeAlarmModal(){ document.getElementById('alarmModal').classList.remove('show'); }

function toggleAlarm(enabled){ 
    alarmSettings.enabled = enabled; 
    saveAlarmSettings(); 
    if(enabled) initAlarmSystem(); else stopAlarmCheck(); 
}

function saveAlarmSettings(){ 
    alarmSettings.startMinutes = parseInt(document.getElementById('alarmStartMinutes').value) || 0;
    alarmSettings.endMinutes = parseInt(document.getElementById('alarmEndMinutes').value) || 5;
    alarmSettings.enabled = document.getElementById('alarmEnabled').checked; 
    saveData(); 
    
    if(alarmSettings.enabled){ 
        startAlarmCheck(); 
        // ì„¤ì • ë³€ê²½ ì‹œ ì¦‰ì‹œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ëŠ” í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ì›í•  ë•Œë§Œ ë²„íŠ¼ í´ë¦­)
    } else { 
        stopAlarmCheck(); 
    } 
}

async function testAlarm(){ 
    if(Notification.permission !== 'granted'){ 
        const permission = await Notification.requestPermission(); 
        if(permission !== 'granted'){ alert('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.'); return; } 
    } 
    
    // í…ŒìŠ¤íŠ¸ ì•Œë¦¼: ì‹œì‘ ì•Œë¦¼ê³¼ ì¢…ë£Œ ì•Œë¦¼ì„ ìˆœì°¨ì ìœ¼ë¡œ ë³´ì—¬ì¤Œ
    new Notification('ğŸ”” ì•ŒëŒ í…ŒìŠ¤íŠ¸ (ì‹œì‘)', { body: `ì„¤ì •ëœ ì‹œê°„: ì‹œì‘ ${alarmSettings.startMinutes}ë¶„ ì „ ì•Œë¦¼`, icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">ğŸ¬</text></svg>' });
    
    setTimeout(() => {
        new Notification('ğŸ”” ì•ŒëŒ í…ŒìŠ¤íŠ¸ (ì¢…ë£Œ)', { body: `ì„¤ì •ëœ ì‹œê°„: ì¢…ë£Œ ${alarmSettings.endMinutes}ë¶„ ì „ ì•Œë¦¼`, icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">âŒ›</text></svg>' });
    }, 1000);
}

function downloadBackup(){ const backupData = { version: '1.0', date: new Date().toISOString(), schedules, templates, memos, alarmSettings }; const dataStr = JSON.stringify(backupData, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `ì¼ì •ë°±ì—…_${new Date().toISOString().split('T')[0]}.json`; link.click(); URL.revokeObjectURL(url); }
function openRestoreModal(){ renderAutoBackupList(); document.getElementById('restoreModal').classList.add('show'); }
function closeRestoreModal(){ document.getElementById('restoreModal').classList.remove('show'); document.getElementById('restoreFile').value = ''; }
function restoreFromFile(input){ const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e){ try { const backupData = JSON.parse(e.target.result); if(confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ë°±ì—… íŒŒì¼ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ createAutoBackup(); if(backupData.schedules) schedules = backupData.schedules; if(backupData.templates) templates = backupData.templates; if(backupData.memos) memos = backupData.memos; if(backupData.alarmSettings) alarmSettings = backupData.alarmSettings; ensureScheduleIds(); saveData(); updateAllTimes(); renderMemos(); if(alarmSettings.enabled){ document.getElementById('alarmEnabled').checked = true; document.getElementById('alarmStartMinutes').value = alarmSettings.startMinutes || 0; document.getElementById('alarmEndMinutes').value = alarmSettings.endMinutes || 5; initAlarmSystem(); } closeRestoreModal(); alert('ë°±ì—… íŒŒì¼ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!'); } } catch(err) { alert('ë°±ì—… íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); } }; reader.readAsText(file); }
function checkAndCreateAutoBackup(){ const today = new Date().toDateString(); const lastBackup = localStorage.getItem('lastAutoBackup'); if(lastBackup !== today){ createAutoBackup(); localStorage.setItem('lastAutoBackup', today); cleanOldBackups(); } }
function createAutoBackup(){ const backupData = { schedules, templates, memos, alarmSettings }; localStorage.setItem(`autoBackup_${new Date().toISOString().split('T')[0]}`, JSON.stringify(backupData)); }
function cleanOldBackups(){ const backupKeys = Object.keys(localStorage).filter(k => k.startsWith('autoBackup_')).sort().reverse(); if(backupKeys.length > 7) backupKeys.slice(7).forEach(key => localStorage.removeItem(key)); }
function renderAutoBackupList(){ const container = document.getElementById('autoBackupList'); const backupKeys = Object.keys(localStorage).filter(k => k.startsWith('autoBackup_')).sort().reverse(); if(backupKeys.length === 0){ container.innerHTML = '<div class="backup-empty">ì €ì¥ëœ ìë™ ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; } container.innerHTML = backupKeys.map(key => { const date = key.replace('autoBackup_', ''); const backupData = JSON.parse(localStorage.getItem(key)); return `<div class="backup-item" onclick="restoreFromAutoBackup('${key}')"><div><div class="backup-date">${date}</div><div class="backup-time">ì¼ì • ${backupData.schedules?.length||0}ê°œ</div></div><div style="color:#3498db; font-size:14px;">â†’</div></div>`; }).join(''); }
function restoreFromAutoBackup(backupKey){ if(confirm('ì´ ì‹œì ì˜ ë°±ì—…ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ createAutoBackup(); const backupData = JSON.parse(localStorage.getItem(backupKey)); if(backupData.schedules) schedules = backupData.schedules; if(backupData.templates) templates = backupData.templates; if(backupData.memos) memos = backupData.memos; if(backupData.alarmSettings) alarmSettings = backupData.alarmSettings; ensureScheduleIds(); saveData(); updateAllTimes(); renderMemos(); if(alarmSettings.enabled){ document.getElementById('alarmEnabled').checked = true; document.getElementById('alarmStartMinutes').value = alarmSettings.startMinutes || 0; document.getElementById('alarmEndMinutes').value = alarmSettings.endMinutes || 5; initAlarmSystem(); } closeRestoreModal(); alert('ë°±ì—…ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!'); } }

// 1ì´ˆë§ˆë‹¤ ìƒíƒœ ì—…ë°ì´íŠ¸
setInterval(() => { calculateTimes(); updateRowStyles(); updateStats(); if(isTimetableMode) renderTimetable(); }, 1000);
loadData();
</script>
</body>
</html>
