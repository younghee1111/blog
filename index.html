<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¼ì •ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>â°</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        html { overflow-y: scroll; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1200px; margin: 20px auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; margin: 20px 0; font-size: 20px; text-align: center; }

        button { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        button:hover { filter: brightness(0.95); }
        .btn-soft-green { background:#E5F7E9; color:#1e5e2f; }
        .btn-soft-violet { background:#F0E9FF; color:#5a2e98; }
        .btn-soft-orange { background:#FFE8D6; color:#8a4b13; }
        .btn-soft-blue { background:#E6F0FF; color:#1b4fa3; }
        .btn-danger { background:#FDE2E1; color:#8B1E1A; }
        .btn-soft-pink { background:#FFE6F0; color:#8B1E5A; }

        .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        .row.space { margin-bottom: 15px; }
        .row .spacer { margin-left:auto; }

        .summary-bar { background:#E8F5E9; padding:12px 15px; border-radius:8px; margin-top:15px; display:flex; justify-content:center; align-items:center; gap:30px; }
        .summary-bar span { font-size:14px; color:#2c3e50; }
        .summary-bar .label { font-weight:bold; }
        .summary-bar .value { font-weight:bold; color:#1e5e2f; }

        table { width:100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 15px; }
        th { background: #34495e; color: white; }

        .duration-cell { background: #ecf0f1; width: 70px; text-align:center; }
        .duration-cell input { text-align:center; width:100%; background: transparent; border: none; outline: none; font-size: 15px; }
        .time-cell { background: #ecf0f1; }
        .task-cell { background: white; text-align:left; }

        .task-input { background: transparent; border: none; outline: none; width: 100%; color:#2c3e50; font-size:15px; padding:8px; }

        #scheduleBody tr.dragging { opacity: 0.5; }
        #scheduleBody tr.drag-over { border-top: 3px solid #3498db; }
        
        .task-cell:focus-within { background:#fafafa !important; }
        
        tr.completed-row .task-cell { background:#f5f5f5 !important; }
        tr.completed-row .task-input { color:#7f8c8d; }
        
        tr.active .task-cell { background:#FFF9E6 !important; }
        tr.active .time-cell { background:#FFF7E6 !important; font-weight:700; }
        
        tr.meal-row .task-cell { background:#F3E8FF !important; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: #2c3e50; font-size: 18px; }
        .modal-close { cursor: pointer; font-size: 28px; color: #95a5a6; line-height: 1; }
        .modal-close:hover { color: #34495e; }
        .modal-body { margin-bottom: 20px; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; }

        .template-item { padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .template-item:hover { background: #f8f9fa; border-color: #3498db; }
        .template-name { font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .template-info { font-size: 12px; color: #7f8c8d; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 14px; }
        .form-group input[type="number"] { width: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .form-group input[type="text"], .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .form-group textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        
        .alarm-section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .alarm-toggle { display: flex; align-items: center; gap: 10px; font-size: 15px; }
        .alarm-toggle input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .alarm-info { margin-top: 15px; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; font-size: 13px; color: #1565c0; line-height: 1.6; }

        @media (max-width: 720px){ 
            th, td { padding:6px; font-size:14px; } 
            button { padding: 6px 10px; font-size: 11px; }
            .modal-content { padding: 20px; }
            .summary-bar { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“… ì¼ì •ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>

    <div class="row space">
        <div class="row">
            <button class="btn-soft-pink" onclick="openTemplateModal()">ğŸ“‹ í…œí”Œë¦¿</button>
            <button class="btn-soft-blue" onclick="openAlarmModal()">ğŸ”” ì•ŒëŒì„¤ì •</button>
        </div>
        <div class="spacer"></div>
        <div class="row">
            <button class="btn-soft-violet" onclick="undoDelete()">â†©ï¸ ì´ì „</button>
            <button class="btn-soft-green" onclick="copyWorkContent()">ğŸ“‹ ì—…ë¬´ë‚´ìš©</button>
        </div>
    </div>

    <table id="scheduleTable">
        <thead>
            <tr>
                <th style="width:70px;">ì‹œê°„ ë‹¨ìœ„</th>
                <th style="width:120px;">ì‹œê°„</th>
                <th>í• ì¼</th>
            </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
    </table>

    <div class="summary-bar">
        <span><span class="label">ë‚¨ì€ ì‹œê°„:</span> <span class="value" id="remainingTime">0ì‹œê°„</span></span>
        <span style="color:#ddd;">|</span>
        <span><span class="label">ì´ ì—…ë¬´:</span> <span class="value" id="workHours">0ì‹œê°„</span></span>
    </div>
</div>

<div id="templateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ“‹ í…œí”Œë¦¿ ê´€ë¦¬</h2>
            <span class="modal-close" onclick="closeTemplateModal()">&times;</span>
        </div>
        <div class="modal-body">
            <button class="btn-soft-green" onclick="openSaveTemplateModal()" style="width:100%; margin-bottom:20px;">ğŸ’¾ í˜„ì¬ ì¼ì •ì„ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥</button>
            <div id="templateList"></div>
        </div>
    </div>
</div>

<div id="saveTemplateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ’¾ í…œí”Œë¦¿ ì €ì¥</h2>
            <span class="modal-close" onclick="closeSaveTemplateModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>í…œí”Œë¦¿ ì´ë¦„</label>
                <input type="text" id="templateName" placeholder="ì˜ˆ: í‰ì¼ ë£¨í‹´" />
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-soft-orange" onclick="closeSaveTemplateModal()">ì·¨ì†Œ</button>
            <button class="btn-soft-green" onclick="saveTemplate()">ì €ì¥</button>
        </div>
    </div>
</div>

<div id="alarmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ”” ì•ŒëŒ ì„¤ì •</h2>
            <span class="modal-close" onclick="closeAlarmModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="alarm-section">
                <label class="alarm-toggle">
                    <input type="checkbox" id="alarmEnabled" onchange="toggleAlarm(this.checked)">
                    <span style="font-weight:600;">ì•ŒëŒ í™œì„±í™”</span>
                </label>
            </div>
            
            <div class="form-group">
                <label>ì¢…ë£Œ ëª‡ ë¶„ ì „ì— ì•Œë¦¼</label>
                <input type="number" id="alarmMinutes" value="5" min="1" max="60" onchange="saveAlarmSettings()">
                <span style="margin-left:8px; color:#7f8c8d;">ë¶„</span>
            </div>

            <button class="btn-soft-blue" onclick="testAlarm()" style="width:100%; padding:12px; font-size:14px;">ğŸ”” ì•ŒëŒ í…ŒìŠ¤íŠ¸</button>
            
            <div class="alarm-info">
                ğŸ’¡ ì•ŒëŒì„ ë°›ìœ¼ë ¤ë©´ ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
                â€¢ ì‹œì‘ ì•Œë¦¼: ê° í• ì¼ ì‹œì‘ ì‹œì <br>
                â€¢ ì¢…ë£Œ ì•Œë¦¼: ì„¤ì •í•œ ì‹œê°„ ì „
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-soft-green" onclick="closeAlarmModal()">í™•ì¸</button>
        </div>
    </div>
</div>

<script>
let schedules = [];
let templates = [];
let draggedIndex = null;
let alarmSettings = { enabled: false, minutesBefore: 5 };
let notifiedTasks = new Set();
let alarmCheckInterval = null;
let deletedHistory = [];
const START_TIME = "9:00";

function loadData(){
    const saved = localStorage.getItem('scheduleData');
    const savedTemplates = localStorage.getItem('templates');
    const savedAlarmSettings = localStorage.getItem('alarmSettings');
    
    if(saved){ schedules = JSON.parse(saved); } 
    else { schedules = [{duration:1, task:''}]; }
    
    if(savedTemplates){ templates = JSON.parse(savedTemplates); }
    
    if(savedAlarmSettings){
        alarmSettings = JSON.parse(savedAlarmSettings);
        document.getElementById('alarmEnabled').checked = alarmSettings.enabled;
        document.getElementById('alarmMinutes').value = alarmSettings.minutesBefore;
    }
    
    ensureDailyReset();
    renderTable();
    initAlarmSystem();
}

function saveData(){
    localStorage.setItem('scheduleData', JSON.stringify(schedules));
    localStorage.setItem('templates', JSON.stringify(templates));
    localStorage.setItem('alarmSettings', JSON.stringify(alarmSettings));
}

function parseTime(t){ const [h, m] = t.split(':').map(Number); return h + m/60; }

function formatTime(h){
    const hours = Math.floor(h);
    const minutes = Math.round((h - hours) * 60);
    let displayHour = hours % 12; 
    if(displayHour === 0) displayHour = 12;
    return `${displayHour}:${minutes.toString().padStart(2,'0')}`;
}

function nowInHours(){ const n = new Date(); return n.getHours() + n.getMinutes()/60; }

function calculateTimes(){
    let cur = parseTime(START_TIME);
    schedules.forEach(s => { 
        s.start = formatTime(cur); 
        s.startNum = cur; 
        cur += s.duration; 
        s.end = formatTime(cur); 
        s.endNum = cur; 
    });
}

function renderTable(){
    calculateTimes();
    updateSummary();
    const tbody = document.getElementById('scheduleBody');
    tbody.innerHTML = '';
    const nowH = nowInHours();
    
    schedules.forEach((s, i) => {
        const tr = document.createElement('tr');
        tr.draggable = true;
        tr.dataset.index = i;
        
        const isMeal = /ì ì‹¬|ì ì‹¬ì‹ì‚¬|ì €ë…|ì €ë…ì‹ì‚¬|íšŒì˜/i.test(s.task);
        if(isMeal) tr.classList.add('meal-row');
        if(nowH >= s.startNum && nowH < s.endNum) tr.classList.add('active');

        const d = document.createElement('td'); 
        d.className = 'duration-cell'; 
        d.innerHTML = `<input type="number" step="0.5" value="${s.duration}" onchange="updateDuration(${i},this.value)">`;
        tr.appendChild(d);
        
        const t = document.createElement('td'); 
        t.className = 'time-cell'; 
        t.textContent = `${s.start} - ${s.end}`;
        tr.appendChild(t);
        
        const task = document.createElement('td'); 
        task.className = 'task-cell';
        task.innerHTML = `<input class='task-input' type='text' value='${s.task || ''}' oninput='updateTaskInput(${i}, this.value)' onblur='updateTask(${i}, this.value)' onkeydown='handleTaskKeyDown(event, ${i})'>`;
        tr.appendChild(task);
        
        tr.addEventListener('dragstart', handleDragStart);
        tr.addEventListener('dragover', handleDragOver);
        tr.addEventListener('drop', handleDrop);
        tr.addEventListener('dragend', handleDragEnd);
        
        tbody.appendChild(tr);
    });
}

function handleDragStart(e){
    draggedIndex = parseInt(this.dataset.index);
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e){
    if(e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    this.classList.add('drag-over');
    return false;
}

function handleDrop(e){
    if(e.stopPropagation) e.stopPropagation();
    const dropIndex = parseInt(this.dataset.index);
    if(draggedIndex !== dropIndex){
        const item = schedules.splice(draggedIndex, 1)[0];
        schedules.splice(dropIndex, 0, item);
        updateAllTimes();
    }
    return false;
}

function handleDragEnd(e){
    document.querySelectorAll('#scheduleBody tr').forEach(tr => {
        tr.classList.remove('dragging', 'drag-over');
    });
}

function updateDuration(i, v){ schedules[i].duration = parseFloat(v) || 0.5; updateAllTimes(); }
function updateTask(i, v){ schedules[i].task = v; saveData(); }
function updateTaskInput(i, v){ schedules[i].task = v; saveData(); }

function handleTaskKeyDown(event, currentIndex){
    // Ctrl + D: í˜„ì¬ í–‰ ë³µì‚¬
    if(event.ctrlKey && event.key === 'd'){
        event.preventDefault();
        schedules[currentIndex].task = event.target.value;
        saveData();
        copyRow(currentIndex);
        return;
    }
    
    // Ctrl + Backspace: í˜„ì¬ í–‰ ì‚­ì œ
    if(event.ctrlKey && event.key === 'Backspace'){
        event.preventDefault();
        deleteCurrentRow(currentIndex);
        return;
    }
    
    // Ctrl + Enter: í˜„ì¬ í–‰ ì•„ë˜ì— ìƒˆ í–‰ ì¶”ê°€
    if(event.ctrlKey && event.key === 'Enter'){
        event.preventDefault();
        schedules[currentIndex].task = event.target.value;
        saveData();
        addRowBelow(currentIndex);
        return;
    }
    
    // Enter: ë‹¤ìŒ í• ì¼ë¡œ ì´ë™
    if(event.key === 'Enter'){
        event.preventDefault();
        schedules[currentIndex].task = event.target.value;
        saveData();
        
        const nextIndex = currentIndex + 1;
        if(nextIndex < schedules.length){
            setTimeout(() => {
                const inputs = document.querySelectorAll('.task-input');
                if(inputs[nextIndex]) inputs[nextIndex].focus();
            }, 0);
        }
        return;
    }
    
    if(event.key === 'ArrowDown'){
        event.preventDefault();
        schedules[currentIndex].task = event.target.value;
        saveData();
        
        const nextIndex = currentIndex + 1;
        if(nextIndex < schedules.length){
            setTimeout(() => {
                const inputs = document.querySelectorAll('.task-input');
                if(inputs[nextIndex]) inputs[nextIndex].focus();
            }, 0);
        }
    } else if(event.key === 'ArrowUp'){
        event.preventDefault();
        schedules[currentIndex].task = event.target.value;
        saveData();
        
        const prevIndex = currentIndex - 1;
        if(prevIndex >= 0){
            setTimeout(() => {
                const inputs = document.querySelectorAll('.task-input');
                if(inputs[prevIndex]) inputs[prevIndex].focus();
            }, 0);
        }
    }
}

function copyRow(i){ 
    const s = schedules[i]; 
    schedules.splice(i + 1, 0, {duration: s.duration, task: ''}); 
    updateAllTimes(); 
    setTimeout(() => {
        const inputs = document.querySelectorAll('.task-input');
        if(inputs[i + 1]) inputs[i + 1].focus();
    }, 0);
}

function deleteCurrentRow(currentIndex){
    if(schedules.length === 1){
        return;
    }
    deletedHistory.push({
        index: currentIndex,
        data: JSON.parse(JSON.stringify(schedules[currentIndex]))
    });
    schedules.splice(currentIndex, 1);
    updateAllTimes();
    setTimeout(() => {
        const inputs = document.querySelectorAll('.task-input');
        const focusIndex = Math.min(currentIndex, inputs.length - 1);
        if(inputs[focusIndex]) inputs[focusIndex].focus();
    }, 0);
}

function addRowBelow(currentIndex){
    schedules.splice(currentIndex + 1, 0, {duration: 1, task: ''});
    updateAllTimes();
    setTimeout(() => {
        const inputs = document.querySelectorAll('.task-input');
        if(inputs[currentIndex + 1]) inputs[currentIndex + 1].focus();
    }, 0);
}

function undoDelete(){
    if(deletedHistory.length === 0){
        return;
    }
    const last = deletedHistory.pop();
    schedules.splice(last.index, 0, last.data);
    updateAllTimes();
}

function copyWorkContent(){
    let content = '';
    schedules.forEach(s => {
        const isMeal = /ì ì‹¬|ì ì‹¬ì‹ì‚¬|ì €ë…|ì €ë…ì‹ì‚¬|íšŒì˜/i.test(s.task);
        if(!isMeal && s.task.trim()){
            content += `- ${s.task}(${s.duration}ì‹œê°„)\n`;
        }
    });
    
    if(!content){
        return;
    }
    
    navigator.clipboard.writeText(content).then(() => {
        // ë³µì‚¬ ì™„ë£Œ (ì•Œë¦¼ ì—†ìŒ)
    }).catch(err => {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
    });
}

function updateAllTimes(){ 
    calculateTimes(); 
    renderTable(); 
    saveData(); 
    notifiedTasks.clear();
}

function updateSummary(){
    let totalHours = 0;
    let workHours = 0;
    
    schedules.forEach(s => {
        totalHours += s.duration;
        const isMeal = /ì ì‹¬|ì ì‹¬ì‹ì‚¬|ì €ë…|ì €ë…ì‹ì‚¬|íšŒì˜/i.test(s.task);
        if(!isMeal){
            workHours += s.duration;
        }
    });
    
    const remaining = 24 - totalHours;
    
    document.getElementById('remainingTime').textContent = formatHours(remaining);
    document.getElementById('workHours').textContent = formatHours(workHours);
}

function formatHours(totalHours){
    const hours = Math.floor(totalHours);
    const minutes = Math.round((totalHours - hours) * 60);
    
    if(hours > 0 && minutes > 0){
        return `${hours}ì‹œê°„ ${minutes}ë¶„`;
    } else if(hours > 0){
        return `${hours}ì‹œê°„`;
    } else if(minutes > 0){
        return `${minutes}ë¶„`;
    } else {
        return `0ì‹œê°„`;
    }
}

function ensureDailyReset(){
    const today = new Date().toDateString();
    const last = localStorage.getItem('lastReset');
    if(last !== today){
        localStorage.setItem('lastReset', today);
        notifiedTasks.clear();
        saveData();
        renderTable();
    }
}

function openTemplateModal(){ renderTemplateList(); document.getElementById('templateModal').classList.add('show'); }
function closeTemplateModal(){ document.getElementById('templateModal').classList.remove('show'); }
function openSaveTemplateModal(){ document.getElementById('templateName').value = ''; document.getElementById('saveTemplateModal').classList.add('show'); }
function closeSaveTemplateModal(){ document.getElementById('saveTemplateModal').classList.remove('show'); }

function saveTemplate(){
    const name = document.getElementById('templateName').value.trim();
    if(!name){ alert('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    
    templates.push({
        id: Date.now(),
        name: name,
        schedules: JSON.parse(JSON.stringify(schedules)),
        createdAt: new Date().toISOString()
    });
    
    saveData();
    closeSaveTemplateModal();
    renderTemplateList();
    alert('í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

function renderTemplateList(){
    const container = document.getElementById('templateList');
    if(templates.length === 0){
        container.innerHTML = '<p style="color:#7f8c8d; text-align:center;">ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    container.innerHTML = templates.map((t, i) => `
        <div class="template-item" onclick="loadTemplate(${i})">
            <div class="template-name">${t.name}</div>
            <div class="template-info">
                ${t.schedules.length}ê°œ ì¼ì • Â· ${new Date(t.createdAt).toLocaleDateString()}
                <button class="btn-danger" onclick="event.stopPropagation(); deleteTemplate(${i})" style="float:right; padding:4px 8px; font-size:11px;">ì‚­ì œ</button>
            </div>
        </div>
    `).join('');
}

function loadTemplate(index){
    if(confirm('í˜„ì¬ ì¼ì •ì„ í…œí”Œë¦¿ìœ¼ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
        const template = templates[index];
        schedules = JSON.parse(JSON.stringify(template.schedules));
        updateAllTimes();
        closeTemplateModal();
        alert('í…œí”Œë¦¿ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
}

function deleteTemplate(index){ if(confirm('ì´ í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ templates.splice(index, 1); saveData(); renderTemplateList(); } }

async function initAlarmSystem(){
    if('Notification' in window && Notification.permission === 'default'){
        await Notification.requestPermission();
    }
    if(alarmSettings.enabled) startAlarmCheck();
}

function startAlarmCheck(){
    if(alarmCheckInterval) clearInterval(alarmCheckInterval);
    alarmCheckInterval = setInterval(checkAndNotify, 10000);
    checkAndNotify();
}

function stopAlarmCheck(){ if(alarmCheckInterval){ clearInterval(alarmCheckInterval); alarmCheckInterval = null; } }

function checkAndNotify(){
    if(!alarmSettings.enabled || Notification.permission !== 'granted') return;
    
    const nowH = nowInHours();
    calculateTimes();
    
    schedules.forEach((s, i) => {
        // ì‹œì‘ ì‹œê°„ ì•Œë¦¼
        const startTaskKey = `start-${s.start}-${s.end}-${s.task}`;
        if(nowH >= s.startNum && nowH < s.startNum + 0.02 && !notifiedTasks.has(startTaskKey)){
            notifiedTasks.add(startTaskKey);
            showStartNotification(s, i);
        }
        
        // ì¢…ë£Œ ì „ ì•Œë¦¼
        const alarmTime = s.endNum - (alarmSettings.minutesBefore / 60);
        const endTaskKey = `end-${s.start}-${s.end}-${s.task}`;
        
        if(nowH >= alarmTime && nowH < s.endNum && !notifiedTasks.has(endTaskKey)){
            notifiedTasks.add(endTaskKey);
            showEndNotification(s, i);
        }
    });
}

function showStartNotification(currentTask, currentIndex){
    const notification = new Notification('ğŸ¯ í• ì¼ ì‹œì‘', {
        body: `[í˜„ì¬ í• ì¼]\n${currentTask.task || 'í• ì¼ ì—†ìŒ'}`,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">ğŸ¯</text></svg>',
        tag: 'schedule-start-' + Date.now(),
        requireInteraction: true,
        silent: false
    });
    
    notification.onclick = function(){ window.focus(); this.close(); };
}

function showEndNotification(currentTask, currentIndex){
    const nextTask = schedules[currentIndex + 1];
    const nextTaskText = nextTask ? (nextTask.task || 'í• ì¼ ì—†ìŒ') : 'ë§ˆì§€ë§‰ ì¼ì •';
    
    const notification = new Notification(`ğŸ“… ${alarmSettings.minutesBefore}ë¶„ ì „ ì¢…ë£Œ`, {
        body: `[ë‹¤ìŒ í• ì¼]\n${nextTaskText}`,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">ğŸ“…</text></svg>',
        tag: 'schedule-end-' + Date.now(),
        requireInteraction: true,
        silent: false
    });
    
    notification.onclick = function(){ window.focus(); this.close(); };
}

function openAlarmModal(){ document.getElementById('alarmModal').classList.add('show'); }
function closeAlarmModal(){ document.getElementById('alarmModal').classList.remove('show'); }

function toggleAlarm(enabled){
    alarmSettings.enabled = enabled;
    saveAlarmSettings();
    if(enabled) initAlarmSystem();
    else stopAlarmCheck();
}

function saveAlarmSettings(){
    alarmSettings.minutesBefore = parseInt(document.getElementById('alarmMinutes').value) || 5;
    alarmSettings.enabled = document.getElementById('alarmEnabled').checked;
    saveData();
    if(alarmSettings.enabled){ 
        notifiedTasks.clear(); 
        startAlarmCheck(); 
        alert('ì•ŒëŒ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
}

async function testAlarm(){
    if(Notification.permission !== 'granted'){
        const permission = await Notification.requestPermission();
        if(permission !== 'granted'){ alert('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì•Œë¦¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.'); return; }
    }
    
    const notification = new Notification('ğŸ”” ì•ŒëŒ í…ŒìŠ¤íŠ¸', {
        body: `ì¢…ë£Œ ${alarmSettings.minutesBefore}ë¶„ ì „\n\në‹¤ìŒ í• ì¼: í…ŒìŠ¤íŠ¸ í• ì¼`,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">ğŸ””</text></svg>',
        tag: 'test-alarm-' + Date.now(),
        requireInteraction: true
    });
    
    notification.onclick = function(){ window.focus(); this.close(); };
}

setInterval(() => {
    const nowH = nowInHours();
    calculateTimes();
    schedules.forEach(s => {
        if(nowH >= s.startNum && nowH < s.endNum){
            renderTable();
        }
    });
}, 60000);

loadData();
</script>
</body>
</html>
