<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¼ì •ê´€ë¦¬ ì‹œìŠ¤í…œ - Netlifyìš©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        html { overflow-y: scroll; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1200px; margin: 20px auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; margin-bottom: 20px; }

        button { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        button:hover { filter: brightness(0.95); }
        .btn-soft-green { background:#E5F7E9; color:#1e5e2f; }
        .btn-soft-violet { background:#F0E9FF; color:#5a2e98; }
        .btn-soft-orange { background:#FFE8D6; color:#8a4b13; }
        .btn-soft-blue { background:#E6F0FF; color:#1b4fa3; }
        .btn-danger { background:#FDE2E1; color:#8B1E1A; }

        .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        .row.space { margin-bottom: 10px; }
        .row .spacer { margin-left:auto; }

        .start-time-input { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .start-time-input label { font-weight: bold; color: #2c3e50; }
        .start-time-input input { width: 150px; padding:8px 10px; border:1px solid #ccc; border-radius:6px; }

        table { width:100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th { background: #34495e; color: white; }

        .duration-cell { background: #ecf0f1; width: 70px; text-align:center; }
        .duration-cell input { text-align:center; width:100%; background: transparent; border: none; outline: none; }
        .time-cell { background: #ecf0f1; }
        .task-cell { background: white; text-align:left; }

        .task-input { background: transparent; border: none; outline: none; width: 100%; color:#2c3e50; font-size:14px; padding:8px; }
        .task-input.done { background: transparent; color:#1e8449; }

        .task-pill { display:block; width:100%; border-radius:6px; padding:2px 5px; font-size:14px; font-weight:500; box-sizing:border-box; }
        .task-pill.green { background:#E8FBE8; color:#1E8449; }
        .task-pill.purple { background:#F3E8FF; color:#5A2E98; }

        .btn-action { margin-left:10px; }

        #scheduleBody tr:hover { background:#fafafa; }
        tr.active .time-cell { background:#FFF7E6 !important; font-weight:700; }
        .task-cell.completed { background:#E8FBE8 !important; }
        .task-cell.meal { background:#F3E8FF !important; color:#5A2E98; }

        @media (max-width: 720px){ th, td { padding:4px; font-size:13px; } .task-pill { padding:2px 5px; } .start-time-input input { width:120px; } }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“… ì¼ì •ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>

    <div class="start-time-input">
        <label>ì‹œì‘ì‹œê°„:</label>
        <input type="text" id="startTime" value="9:00" onchange="updateAllTimes()" placeholder="ì˜ˆ: 9:00" />
    </div>

    <div class="row space">
        <div class="row">
            <button class="btn-soft-green" onclick="addRow()">â• í–‰ ì¶”ê°€</button>
            <button class="btn-soft-violet" onclick="resetChecks()">âœ… ì²´í¬ ì´ˆê¸°í™”</button>
        </div>
        <div class="spacer"></div>
        <div class="row">
            <button class="btn-soft-orange" onclick="clearData()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
            <button class="btn-soft-blue" onclick="exportAll()">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
            <button class="btn-soft-violet" onclick="document.getElementById('importFile').click()">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importAll(event)" />
            <button class="btn-soft-green" onclick="notifyTest()">ğŸ”” ì•Œë¦¼ í…ŒìŠ¤íŠ¸</button>
        </div>
    </div>

    <table id="scheduleTable">
        <thead>
            <tr>
                <th style="width:70px;">ì‹œê°„ ë‹¨ìœ„</th>
                <th style="width:120px;">ì‹œê°„</th>
                <th style="width:50px;">ì™„ë£Œ</th>
                <th>í• ì¼</th>
                <th style="width:130px;">ì‘ì—…</th>
            </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
    </table>
</div>

<script>
let schedules = [];
let savedStartTime = '9:00';
let notificationPermissionRequested = false;

function loadData(){
    const saved = localStorage.getItem('scheduleData');
    const savedTime = localStorage.getItem('startTime');
    if(saved){
        schedules = JSON.parse(saved);
    } else {
        const auto = localStorage.getItem('autoBackup');
        if(auto){
            try{
                const data = JSON.parse(auto);
                if(Array.isArray(data.schedules)) schedules = data.schedules;
                if(data.startTime) document.getElementById('startTime').value = data.startTime;
            }catch(e){ schedules = [{duration:1, task:'', completed:false}]; }
        } else {
            schedules = [{duration:1, task:'', completed:false}];
        }
    }
    if(savedTime){ document.getElementById('startTime').value = savedTime; }
    ensureDailyReset();
    renderTable();
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¶Œí•œ ìš”ì²­ (í•œ ë²ˆë§Œ)
    requestNotificationPermissionOnce();
}

function requestNotificationPermissionOnce(){
    if(!('Notification' in window)) return;
    if(notificationPermissionRequested) return;
    
    const permissionAsked = localStorage.getItem('notificationPermissionAsked');
    if(permissionAsked === 'true') {
        notificationPermissionRequested = true;
        return;
    }
    
    if(Notification.permission === 'default'){
        Notification.requestPermission().then(permission => {
            console.log('ì•Œë¦¼ ê¶Œí•œ:', permission);
            localStorage.setItem('notificationPermissionAsked', 'true');
            notificationPermissionRequested = true;
        });
    } else {
        notificationPermissionRequested = true;
    }
}

function saveData(){
    localStorage.setItem('scheduleData', JSON.stringify(schedules));
    localStorage.setItem('startTime', document.getElementById('startTime').value);
    autoBackup();
}

function parseTime(t){ const [h,m] = t.split(':').map(Number); return h + m/60; }
function formatTime(h){
    const hours = Math.floor(h);
    const minutes = Math.round((h - hours) * 60);
    let displayHour = hours % 12; if(displayHour === 0) displayHour = 12;
    const ampm = hours < 12 ? '' : '';
    return `${displayHour}:${minutes.toString().padStart(2,'0')} ${ampm}`;
}
function nowInHours(){ const n=new Date(); return n.getHours() + n.getMinutes()/60; }

function calculateTimes(){
    let cur = parseTime(document.getElementById('startTime').value);
    schedules.forEach(s=>{ s.start = formatTime(cur); s.startNum = cur; cur += s.duration; s.end = formatTime(cur); s.endNum = cur; });
}

function renderTable(){
    calculateTimes();
    const tbody = document.getElementById('scheduleBody');
    tbody.innerHTML = '';
    const nowH = nowInHours();
    schedules.forEach((s,i)=>{
        const tr = document.createElement('tr');
        if(nowH>=s.startNum && nowH<s.endNum) tr.classList.add('active');

        const d = document.createElement('td'); d.className='duration-cell'; d.innerHTML=`<input type="number" step="0.5" value="${s.duration}" onchange="updateDuration(${i},this.value)">`; tr.appendChild(d);
        const t = document.createElement('td'); t.className='time-cell'; t.textContent = `${s.start} - ${s.end}`; tr.appendChild(t);
        const c = document.createElement('td'); c.innerHTML = `<input type='checkbox' ${s.completed?'checked':''} onchange='toggleCompleted(${i},this.checked)'>`; tr.appendChild(c);

        const task = document.createElement('td'); task.className='task-cell';
        const taskInput = `<input class='task-input${s.completed?' done':''}' type='text' value='${s.task||''}' onchange='updateTask(${i},this.value)'>`;
        const isMeal = /ì ì‹¬|ì €ë…|lunch|dinner/.test(s.task);
        task.innerHTML = isMeal ? `<div class='task-pill purple'>${taskInput}</div>` : `${taskInput}`;
        if(s.completed) task.classList.add('completed');
        if(isMeal) task.classList.add('meal');
        tr.appendChild(task);

        const ops = document.createElement('td');
        ops.innerHTML = `<button class='btn-soft-blue' onclick='copyRow(${i})'>ë³µì‚¬</button><button class='btn-danger btn-action' onclick='deleteRow(${i})'>ì‚­ì œ</button>`;
        tr.appendChild(ops);
        tbody.appendChild(tr);
    });
}

function updateDuration(i,v){ schedules[i].duration = parseFloat(v) || 0.5; updateAllTimes(); }
function updateTask(i,v){ schedules[i].task=v; saveData(); renderTable(); }
function toggleCompleted(i,ch){
    schedules[i].completed = !!ch;
    const row = document.querySelectorAll('#scheduleBody tr')[i];
    const taskCell = row ? row.querySelector('.task-cell') : null;
    if(taskCell){ taskCell.classList.toggle('completed', !!ch); }
    const input = row ? row.querySelector('.task-input') : null;
    if(input){ if(ch) input.classList.add('done'); else input.classList.remove('done'); }
    saveData();
}

function addRow(){ schedules.push({duration:1, task:'', completed:false}); updateAllTimes(); }
function deleteRow(i){ if(schedules.length===1){ alert('ìµœì†Œ 1í–‰ í•„ìš”'); return; } schedules.splice(i,1); updateAllTimes(); }
function copyRow(i){ const s=schedules[i]; const c={duration:s.duration, task:'', completed:false}; schedules.splice(i+1,0,c); updateAllTimes(); }
function resetChecks(){ schedules.forEach(s=>s.completed=false); saveData(); renderTable(); }

function updateAllTimes(){ calculateTimes(); renderTable(); saveData(); autoCheckByNow(); }

function autoCheckByNow(){ ensureDailyReset(); const n=nowInHours(); let changed=false; calculateTimes(); schedules.forEach(s=>{ if(!s.completed && n>=s.endNum){ s.completed=true; changed=true; } }); if(changed){ saveData(); renderTable(); } }

function ensureDailyReset(){
    const today = new Date().toDateString();
    const last = localStorage.getItem('lastReset');
    if(last !== today){
        schedules.forEach(s=>{ s.completed=false; s._notified5 = false; });
        localStorage.setItem('lastReset', today);
        saveData();
        renderTable();
    }
}

function clearData(){ if(confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ localStorage.clear(); location.reload(); } }

function exportAll(){ const blob=new Blob([JSON.stringify(schedules,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='schedule_backup.json'; a.click(); }
function importAll(e){ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ schedules=JSON.parse(r.result); saveData(); renderTable(); }; r.readAsText(f); }

function autoBackup(){
    try{
        const payload = { schedules, startTime: document.getElementById('startTime').value, ts: new Date().toISOString() };
        localStorage.setItem('autoBackup', JSON.stringify(payload));
    }catch(e){ console.warn('ìë™ ë°±ì—… ì‹¤íŒ¨:', e); }
}

function notifyUpcomingTasks(){
    if(!('Notification' in window)) return;
    if(Notification.permission !== 'granted') {
        console.log('ì•Œë¦¼ ê¶Œí•œ ì—†ìŒ:', Notification.permission);
        return;
    }

    const now = nowInHours();
    let changed = false;
    
    schedules.forEach((s, idx)=>{
        if(s.completed || s._notified5) return;
        
        const diff = s.endNum - now; // ì‹œê°„ ë‹¨ìœ„ ì°¨ì´
        const diffMinutes = diff * 60; // ë¶„ ë‹¨ìœ„ë¡œ ë³€í™˜
        
        console.log(`[${idx}] ${s.task}: ì¢…ë£Œê¹Œì§€ ${diffMinutes.toFixed(1)}ë¶„ (${diff.toFixed(3)}ì‹œê°„)`);
        
        // 5ë¶„ ì´í•˜, 0ë¶„ ì´ˆê³¼ì¼ ë•Œ ì•Œë¦¼
        if(diffMinutes <= 5 && diffMinutes > 0){
            try{ 
                new Notification('â° ê³§ ì¼ì • ì¢…ë£Œ', { 
                    body: `${s.task || 'ì´ë¦„ ì—†ëŠ” ì¼ì •'} ê°€ ì•½ ${Math.round(diffMinutes)}ë¶„ í›„ ì¢…ë£Œë©ë‹ˆë‹¤.`,
                    icon: 'â°'
                });
                console.log('âœ… ì•Œë¦¼ ë°œì†¡:', s.task);
            }catch(e){
                console.error('ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨:', e);
            }
            s._notified5 = true;
            changed = true;
        }
    });
    
    if(changed) saveData();
}

setInterval(autoCheckByNow, 60000);
setInterval(autoBackup, 300000);
setInterval(notifyUpcomingTasks, 60000);

function notifyTest(){
    if(!('Notification' in window)) { 
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); 
        return; 
    }
    
    console.log('í˜„ì¬ ì•Œë¦¼ ê¶Œí•œ:', Notification.permission);
    
    const fireTestNotification = ()=> {
        try {
            new Notification('ğŸ”” í…ŒìŠ¤íŠ¸ ì•Œë¦¼', { 
                body: 'ì•Œë¦¼ì´ ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤!',
                icon: 'ğŸ””'
            });
            console.log('âœ… í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡ ì„±ê³µ');
        } catch(e) {
            console.error('âŒ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨:', e);
            alert('ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ' + e.message);
        }
    };
    
    if(Notification.permission === 'granted') { 
        fireTestNotification();
    } else if(Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            console.log('ê¶Œí•œ ìš”ì²­ ê²°ê³¼:', permission);
            if(permission === 'granted') {
                fireTestNotification();
            } else {
                alert('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        });
    } else {
        alert('ì•Œë¦¼ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì–´ ìˆì–´ìš”.\në¸Œë¼ìš°ì € ì„¤ì • > ì‚¬ì´íŠ¸ ì„¤ì • > ì•Œë¦¼ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
    }
}

loadData();

// í˜ì´ì§€ ë¡œë“œ ì§í›„ ì•Œë¦¼ ì²´í¬ í•œ ë²ˆ ì‹¤í–‰
setTimeout(notifyUpcomingTasks, 1000);
</script>
</body>
</html>
