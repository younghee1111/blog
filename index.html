<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì¼ì •ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>â°</text></svg>'>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* (ìƒëµ: ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì „ì²´ ë™ì¼) */
</style>
</head>
<body>
<!-- (ìƒëµ: ê¸°ì¡´ HTML ì „ì²´ ë™ì¼) -->

<script>
/* ------------------------------
   âœ” 1) ì¼ì • ë°ì´í„° êµ¬ì¡° ë³€ê²½
   âœ” 2) ì‚­ì œ/ì´ì „ ë²„ê·¸ í•´ê²°
   âœ” 3) ë©”ëª¨ ë“œë˜ê·¸ ë²„ê·¸ í•´ê²°
   âœ” 4) ì•ŒëŒ ì¤‘ë³µ ë°©ì§€ ì ìš©
-------------------------------- */

let schedules = [];
let templates = [];
let deletedHistory = [];
let memos = [];
let selectedMemoColor = '#FFF9E6';
let draggedMemoIndex = null;
let alarmSettings = { enabled: false, minutesBefore: 5 };
let notifiedTasks = new Set();
let alarmCheckInterval = null;
const START_TIME = "9:00";

/* ------------------------------
   âœ” schedule row: ê³ ìœ  id ìƒì„±
-------------------------------- */
function createSchedule(duration=1, task="", completed=false){
    return {
        id: Date.now() + Math.random(),
        duration, task, completed,
        start:"", end:"", startNum:0, endNum:0
    };
}

function loadData(){
    const saved = localStorage.getItem('scheduleData');
    if(saved){ schedules = JSON.parse(saved); }
    else { schedules = [ createSchedule() ]; }

    const savedTemplates = localStorage.getItem('templates');
    if(savedTemplates) templates = JSON.parse(savedTemplates);

    const savedAlarmSettings = localStorage.getItem('alarmSettings');
    if(savedAlarmSettings) alarmSettings = JSON.parse(savedAlarmSettings);

    const savedMemos = localStorage.getItem('dailyMemos');
    if(savedMemos) memos = JSON.parse(savedMemos);

    renderMemos();
    calculateTimes();
    renderTable();
    initAlarmSystem();
}

function saveData(){
    localStorage.setItem('scheduleData', JSON.stringify(schedules));
    localStorage.setItem('dailyMemos', JSON.stringify(memos));
    localStorage.setItem('templates', JSON.stringify(templates));
    localStorage.setItem('alarmSettings', JSON.stringify(alarmSettings));
}

/* ------------------------------
   âœ” ì‚­ì œ ë²„ê·¸ ìˆ˜ì • (id ê¸°ë°˜)
-------------------------------- */
function deleteRowById(rowId){
    const index = schedules.findIndex(s => s.id === rowId);
    if(index === -1) return;
    if(schedules.length === 1) return;

    deletedHistory.push({ index, data: JSON.parse(JSON.stringify(schedules[index])) });
    schedules.splice(index, 1);
    updateAllTimes();
}

function undoDelete(){
    if(deletedHistory.length === 0) return;

    const last = deletedHistory.pop();
    schedules.splice(last.index, 0, last.data);
    updateAllTimes();
}

/* ------------------------------
   âœ” ë©”ëª¨ ë“œë˜ê·¸ ë²„ê·¸ í•´ê²°
-------------------------------- */
function renderMemos(){
    const box = document.getElementById('memoList');
    box.innerHTML = '';

    if(memos.length === 0){
        const empty = document.createElement('div');
        empty.textContent = 'ë©”ëª¨ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš” ğŸ“';
        empty.className = 'memo-empty';
        box.appendChild(empty);
        return;
    }

    memos.forEach((memo, index) => {
        const div = document.createElement('div');
        div.className = 'memo-item';
        div.draggable = true;
        div.dataset.index = index;
        div.style.background = memo.color;
        div.textContent = memo.text;

        const del = document.createElement('button');
        del.className = 'memo-delete';
        del.textContent = 'Ã—';
        del.onclick = (e)=>{ e.stopPropagation(); deleteMemo(memo.id); };
        div.appendChild(del);

        div.addEventListener('dragstart', ()=>{ draggedMemoIndex = index; div.classList.add('dragging'); });
        div.addEventListener('dragend', ()=>{
            document.querySelectorAll('.memo-item').forEach(v=>v.classList.remove('dragging'));
        });

        div.addEventListener('dragover',(e)=>{e.preventDefault();});
        div.addEventListener('drop',(e)=>{
            e.preventDefault();
            const dropIndex = index;
            const memoItem = memos.splice(draggedMemoIndex,1)[0];
            memos.splice(dropIndex,0,memoItem);
            saveData();
            renderMemos();
        });

        box.appendChild(div);
    });

    /* ë§¨ ë§ˆì§€ë§‰ ë“œë¡­ ì˜ì—­ */
    const tail = document.createElement('div');
    tail.style.height = '30px';
    tail.style.border = '2px dashed transparent';
    tail.addEventListener('dragover', e=>e.preventDefault());
    tail.addEventListener('drop', e=>{
        e.preventDefault();
        if(draggedMemoIndex==null) return;
        const memoItem = memos.splice(draggedMemoIndex,1)[0];
        memos.push(memoItem);
        saveData();
        renderMemos();
    });
    box.appendChild(tail);
}

function deleteMemo(id){
    memos = memos.filter(m => m.id !== id);
    saveData();
    renderMemos();
}

/* ------------------------------
   âœ” ì•ŒëŒ ì¤‘ë³µ ë°©ì§€ (start/end 1íšŒ)
-------------------------------- */
const WINDOW = 0.05; // ì•½ 3ë¶„ í—ˆìš© êµ¬ê°„

function initAlarmSystem(){
    if(alarmSettings.enabled) startAlarmCheck();
}

function startAlarmCheck(){
    if(alarmCheckInterval) clearInterval(alarmCheckInterval);
    alarmCheckInterval = setInterval(()=>checkAndNotify(nowInHours()), 10000);
}

function stopAlarmCheck(){
    if(alarmCheckInterval) clearInterval(alarmCheckInterval);
}

function checkAndNotify(nowH){
    if(!alarmSettings.enabled) return;
    calculateTimes();

    schedules.forEach(s => {
        const startKey = `start-${s.id}`;
        const endKey   = `end-${s.id}`;

        // ì‹œì‘ ì•ŒëŒ
        if(
            nowH >= s.startNum &&
            nowH <  s.startNum + WINDOW &&
            !notifiedTasks.has(startKey)
        ){
            notifiedTasks.add(startKey);
            showStartNotification(s);
        }

        // ì¢…ë£Œ ì•ŒëŒ
        const alarmTime = s.endNum - alarmSettings.minutesBefore/60;
        if(
            nowH >= alarmTime &&
            nowH <  alarmTime + WINDOW &&
            !notifiedTasks.has(endKey)
        ){
            notifiedTasks.add(endKey);
            showEndNotification(s);
        }
    });
}

function showStartNotification(s){
    new Notification('ğŸ¯ í• ì¼ ì‹œì‘',{
        body:`${s.task}`,
        requireInteraction:true
    });
}

function showEndNotification(s){
    new Notification(`ğŸ“… ì¢…ë£Œ ${alarmSettings.minutesBefore}ë¶„ ì „`,{
        body:`${s.task}`,
        requireInteraction:true
    });
}

/* ------------------------------
   âœ” ì¼ì • ë Œë”ë§ + ì‚­ì œ/ì¶”ê°€ ë¡œì§ ê°œì„ 
-------------------------------- */
function renderTable(){
    const tbody = document.getElementById('scheduleBody');
    tbody.innerHTML = '';

    schedules.forEach((s,i)=>{
        const tr = document.createElement('tr');
        tr.dataset.id = s.id;

        // duration
        const d = document.createElement('td');
        const durationInput = document.createElement('input');
        durationInput.type='number'; durationInput.step='0.5'; durationInput.value=s.duration;
        durationInput.onchange = ()=>{
            s.duration = parseFloat(durationInput.value)||0.5;
            updateAllTimes();
        };
        d.appendChild(durationInput);
        tr.appendChild(d);

        // time
        const t = document.createElement('td');
        t.textContent = `${s.start} - ${s.end}`;
        tr.appendChild(t);

        // task
        const taskTd = document.createElement('td');
        const input = document.createElement('input');
        input.value = s.task;
        input.className = 'task-input';

        input.addEventListener('keydown',(e)=>{
            if(e.ctrlKey && e.key==='Backspace'){
                e.preventDefault();
                deleteRowById(s.id);
                return;
            }
        });

        input.addEventListener('input',()=>{ s.task = input.value; });
        input.addEventListener('blur',saveData);

        taskTd.appendChild(input);
        tr.appendChild(taskTd);
        tbody.appendChild(tr);
    });
}

/* ------------------------------ */
function calculateTimes(){
    let cur = parseTime(START_TIME);
    schedules.forEach(s =>{
        s.startNum = cur;
        s.start = formatTime(cur);
        cur += s.duration;
        s.endNum = cur;
        s.end = formatTime(cur);
    });
}

function updateAllTimes(){
    calculateTimes();
    renderTable();
    saveData();
}

function parseTime(t){ const [h,m]=t.split(':').map(Number); return h+m/60; }
function formatTime(h){ const hh=Math.floor(h); const mm=Math.round((h-hh)*60); return `${hh}:${mm.toString().padStart(2,'0')}`; }
function nowInHours(){ const n=new Date(); return n.getHours()+n.getMinutes()/60; }

loadData();
</script>
</body>
</html>
